{% extends "layout.html" %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center gap-2">
    {% if promoter %}
      <img src="{{ promoter.logo_url or url_for('static', filename='img/logo.png') }}" class="station-logo">
      <h6 class="m-0">Conciertos por promotor — {{ promoter.nick }}</h6>
    {% else %}
      <h6 class="m-0">Conciertos por promotor</h6>
    {% endif %}
  </div>
  <div class="badge bg-light text-dark px-3 py-2">{{ day.strftime('%d/%m/%Y') }}</div>
</div>

{% for artist, concerts in grouped.items() %}
  <div class="mb-3 border rounded bg-white">
    <div class="p-2 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <img src="{{ artist.photo_url or url_for('static', filename='img/logo.png') }}" class="artist-avatar me-2">
        <h5 class="m-0">{{ artist.name }}</h5>
      </div>
      <button class="btn btn-sm btn-light toggle-artist collapsed" type="button"
              data-bs-toggle="collapse" data-bs-target="#artist-{{ artist.id }}-concerts">
        <i class="fa fa-chevron-down chevron"></i>
      </button>
    </div>

    <div id="artist-{{ artist.id }}-concerts" class="collapse">
      <div class="p-2">
        {% for c in concerts %}
          {% set total = totals.get(c.id, 0) %}
          {% set today = today_map.get(c.id, 0) %}
          {% set pct = ((total / c.capacity) * 100) if c.capacity else 0 %}
          {% set pending = (c.capacity - total) if c.capacity and total < c.capacity else 0 %}
          {% set days_left = (c.date - day).days %}
          {% set be_pct = ((c.break_even_ticket / c.capacity) * 100) if c.capacity else 0 %}
          {% set reached = total >= c.break_even_ticket %}

          <div class="card mb-2">
            <div class="card-body py-3">
              <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="d-flex align-items-center flex-wrap gap-3">
                  <div class="text-muted"><small>{{ c.date.strftime('%d/%m/%Y') }}</small></div>
                  {% if c.festival_name %}<div class="text-muted"><small>{{ c.festival_name }}</small></div>{% endif %}
                  <div class="text-muted"><small>{{ c.venue.municipality or '' }}</small></div>
                  <div class="text-muted"><small>{{ c.venue.province or '' }}</small></div>
                  <div class="text-muted"><small>Salida a la venta: {{ c.sale_start_date.strftime('%d/%m/%Y') }}</small></div>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge bg-secondary">Faltan: {{ days_left if days_left>=0 else 0 }} días</span>
                  {% if c.sold_out %}<span class="badge bg-danger">SOLD OUT</span>{% endif %}
                </div>
              </div>

              <div class="row row-cols-2 row-cols-md-6 g-2 text-center mt-2">
                <div><small class="text-muted d-block">Vendidas hoy</small><div class="fw-semibold">{{ today|k }}</div></div>
                <div><small class="text-muted d-block">Total vendidas</small><div class="fw-semibold">{{ total|k }}</div></div>
                <div><small class="text-muted d-block">% venta</small><div class="fw-semibold">{{ '%.1f' % pct }}</div></div>
                <div><small class="text-muted d-block">Aforo</small><div class="fw-semibold">{{ c.capacity|k }}</div></div>
                <div><small class="text-muted d-block">Pendientes</small><div class="fw-semibold">{{ pending|k }}</div></div>
                <div>
                  <small class="text-muted d-block">Punto de empate</small>
                  <span class="badge {% if reached %}bg-success{% else %}bg-secondary{% endif %}">
                    {{ c.break_even_ticket|k }} ({{ '%.0f' % be_pct }}%)
                  </span>
                </div>
              </div>

              <div class="text-end mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="openSalesChart('{{ c.id }}')">
                  <i class="fa fa-chart-line"></i> Evolución
                </button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endfor %}
{% endblock %}