{% extends "layout.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
  <div>
    <h2 class="mb-0">Actualizar ventas — {{ day.strftime('%d/%m/%Y') }}</h2>
    <small class="text-muted">Actualiza las ventas del día sin salir de esta pantalla.</small>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('sales_update_view', d=prev_day.isoformat()) }}">
      ← {{ prev_day.strftime('%d/%m/%Y') }}
    </a>
    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('sales_update_view', d=next_day.isoformat()) }}">
      {{ next_day.strftime('%d/%m/%Y') }} →
    </a>

    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#salesReportModal">
      <i class="fa-solid fa-file-export me-1"></i> Generar informe
    </button>
  </div>
</div>


{% for sale_type in order %}
  {% set concerts = sections.get(sale_type, []) %}
  {% if concerts and concerts|length %}
    <h4 class="mt-4">{{ titles.get(sale_type, sale_type) }}</h4>

    <div class="row g-2">
      {% for c in concerts %}
        {% set sold_total = totals.get(c.id, 0) %}
        {% set sold_today = today_map.get(c.id, 0) %}
        {% set cap = capacity_map.get(c.id, c.capacity or 0) %}
        {% set pct = (sold_total / cap * 100) if cap and cap > 0 else 0 %}
        {% set pending = (cap - sold_total) if cap and cap > 0 else 0 %}
        {% set updated_last = last_map.get(c.id) %}
        {% set card_state = "sales-card-updated" if updated_last == day else ("sales-card-pending" if updated_last else "sales-card-never") %}
        {% set has_rebate_cfg = (c.ticketers|selectattr('rebate_mode')|list|length) > 0 %}

<div class="col-12">
  <div class="card shadow-sm sales-card {{ card_state }}" id="concert-{{ c.id }}">
    <div class="card-body py-2">
      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div class="me-auto">
          <div class="fw-bold">{{ c.artist.name if c.artist else 'Sin artista' }}</div>
          <div class="text-muted small">
            {{ c.date.strftime('%d/%m/%Y') if c.date else '' }}
            {% if c.venue %} · {{ c.venue.name }}{% endif %}
            {% if c.venue and c.venue.municipality %} · {{ c.venue.municipality }}{% endif %}
          </div>
        </div>

        <div class="d-flex align-items-center gap-1">
          <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#salesUpdateModal-{{ c.id }}">
            <i class="fa-solid fa-pen-to-square me-1"></i> Actualizar ventas
          </button>

          <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#cfgModal-{{ c.id }}" title="Configuración de ventas">
            <i class="fa-solid fa-gear"></i>
          </button>

          {% if CAN_VIEW_ECON %}
            <a class="btn btn-sm btn-outline-secondary" title="Informe" target="_blank"
               href="{{ url_for('sales_event_report_view', cid=c.id, d=day.isoformat()) }}">
              <i class="fa fa-file-lines"></i>
            </a>
          {% endif %}
          <button type="button" class="btn btn-sm btn-outline-primary" title="Evolución"
                  onclick="openSalesChart('{{ c.id }}')">
            <i class="fa fa-chart-line"></i>
          </button>

          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('concert_edit_view', cid=c.id) }}" title="Editar concierto">
            <i class="fa-solid fa-pen"></i>
          </a>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mt-2">
        <div class="d-flex flex-wrap gap-2">
          {% if updated_last == day %}
            <span class="badge text-bg-success">Actualizado hoy</span>
          {% elif updated_last %}
            <span class="badge text-bg-warning text-dark">Pendiente (última: {{ updated_last.strftime('%d/%m/%Y') }})</span>
          {% else %}
            <span class="badge text-bg-danger">Pendiente (sin datos)</span>
          {% endif %}

          {% if c.sale_start_date %}
            <span class="badge text-bg-light border">Salida: {{ c.sale_start_date.strftime('%d/%m/%Y') }}</span>
          {% endif %}

          {% if c.sold_out %}
            <span class="badge bg-dark">SOLD OUT</span>
          {% endif %}
        </div>

        <form method="post" action="{{ url_for('sales_toggle_soldout', cid=c.id) }}" class="m-0">
          <input type="hidden" name="day" value="{{ day.isoformat() }}">
          <button class="btn btn-sm btn-outline-dark" type="submit">
            {% if c.sold_out %}Quitar SOLD OUT{% else %}Marcar SOLD OUT{% endif %}
          </button>
        </form>
      </div>

      <div class="metrics-inline mt-2">
        <div class="metric">
          <small class="text-muted d-block">Vendidas hoy</small>
          <div class="fw-semibold">{{ sold_today }}</div>
        </div>
        <div class="metric">
          <small class="text-muted d-block">% venta</small>
          <div class="fw-semibold">{{ "%.1f"|format(pct) }}%</div>
        </div>
        <div class="metric">
          <small class="text-muted d-block">Vendidas total</small>
          <div class="fw-semibold">{{ sold_total }}</div>
        </div>
        <div class="metric">
          <small class="text-muted d-block">Aforo a la venta</small>
          <div class="fw-semibold">{{ cap }}</div>
        </div>
        <div class="metric">
          <small class="text-muted d-block">Pendientes</small>
          <div class="fw-semibold">{{ pending if pending > 0 else 0 }}</div>
        </div>

        {% if CAN_VIEW_ECON %}
          <div class="metric">
            <small class="text-muted d-block">Bruto</small>
            <div class="fw-semibold">{{ (gross_map.get(c.id, 0.0) or 0.0)|eur }}</div>
          </div>
          <div class="metric">
            <small class="text-muted d-block">Neto</small>
            <div class="fw-semibold">{{ (net_map.get(c.id, 0.0) or 0.0)|eur }}</div>
          </div>
          {% if has_rebate_cfg %}
            <div class="metric">
              <small class="text-muted d-block">Rebate neto</small>
              <div class="fw-semibold">{{ (rebate_net_map.get(c.id, 0.0) or 0.0)|eur }}</div>
            </div>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </div>
</div>

        {# ---------------- MODAL: ACTUALIZAR VENTAS ---------------- #}
        <div class="modal fade" id="salesUpdateModal-{{ c.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <div>
                  <h5 class="modal-title mb-0">Actualizar ventas</h5>
                  <div class="text-muted small">
                    {{ c.artist.name if c.artist else 'Sin artista' }}
                    {% if c.date %} · {{ c.date.strftime('%d/%m/%Y') }}{% endif %}
                    {% if c.venue %} · {{ c.venue.name }}{% endif %}
                  </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>

              <div class="modal-body">

                {# Si no hay configuración avanzada, usamos modo básico #}
                {% if (not c.ticket_types) or (not c.ticketers) %}
                  <div class="alert alert-warning">
                    Este evento no tiene <strong>categorías</strong> y/o <strong>ticketeras</strong> configuradas. Se actualizará en modo básico.
                  </div>

                  <form method="post" action="{{ url_for('sales_save') }}">
                    <input type="hidden" name="concert_id" value="{{ c.id }}">
                    <input type="hidden" name="day" value="{{ day.isoformat() }}">

                    <div class="row g-3 align-items-end">
                      <div class="col-md-4">
                        <label class="form-label">Entradas vendidas HOY (total)</label>
                        <input class="form-control" type="number" min="0" step="1" name="sold_today" value="{{ sold_today }}">
                      </div>

                      <div class="col-md-8 d-flex gap-2 justify-content-end">
                        <button class="btn btn-primary" type="submit">
                          <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
                        </button>
                        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
                      </div>
                    </div>
                  </form>

                {% else %}
                  <div class="alert alert-light border">
                    <div class="d-flex flex-wrap gap-3">
                      <div><strong>IVA:</strong> {{ (c.sales_config.vat_pct if c.sales_config else 0) or 0 }}%</div>
                      <div><strong>SGAE:</strong> {{ (c.sales_config.sgae_pct if c.sales_config else 0) or 0 }}%</div>
                      {% if CAN_VIEW_ECON %}
                        <div class="ms-auto"><strong>Bruto:</strong> {{ "%.2f"|format(gross_map.get(c.id, 0.0) or 0.0) }} €</div>
                        <div><strong>Neto:</strong> {{ "%.2f"|format(net_map.get(c.id, 0.0) or 0.0) }} €</div>
                        {% if has_rebate_cfg %}
                        <div><strong>Rebate neto:</strong> {{ "%.2f"|format(rebate_net_map.get(c.id, 0.0) or 0.0) }} €</div>
                      {% endif %}
                      {% endif %}
                    </div>
                  </div>

                  {% for ct in c.ticketers %}
                    {% set tid = ct.ticketer_id %}
                    {% set key = (c.id|string) + ':' + (tid|string) %}
                    {% set has_today = (key in ticketer_has_today) %}

                    <div class="card mb-3">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                          <img src="{{ ct.ticketer.logo_url or url_for('static', filename='img/default_promoter.png') }}" class="station-logo me-2" style="width:22px;height:22px;object-fit:contain;" alt="">
                          <strong>{{ ct.ticketer.name }}</strong>
                          <span class="text-muted ms-2">Aforo a la venta: {{ ticketer_capacity_cfg_map.get(c.id, {}).get(tid, 0) }}</span>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                          {% if CAN_VIEW_ECON %}
                            <span class="text-muted small">
                              Bruto (acum): {{ "%.2f"|format(ticketer_totals_map.get(c.id, {}).get(tid, {}).get('gross', 0.0) or 0.0) }} €
                              {% if ct.rebate_mode %}· Rebate neto: {{ "%.2f"|format(rebate_net_by_ticketer_map.get(c.id, {}).get(tid, 0.0) or 0.0) }} €{% endif %}
                            </span>
                          {% endif %}
</div>
                      </div>

                      <div class="card-body">

                        <form method="post" action="{{ url_for('sales_ticketer_day_save', cid=c.id, tid=tid) }}">
                          <input type="hidden" name="day" value="{{ day.isoformat() }}">

                          <div class="table-responsive">
                            <table class="table table-sm align-middle">
                              <thead>
                                <tr>
                                  <th>Tipo</th>
                                  <th class="text-end">Precio bruto</th>
                                  <th class="text-end">Hoy</th>
                                  <th class="text-end">Vendidas</th>
                                  <th class="text-end">% venta</th>
                                  <th class="text-end">Pendientes</th>
                                  <th class="text-end">Configuradas</th>
                                </tr>
                              </thead>
                              <tbody>
                                {% for tt in c.ticket_types %}
                                  {% set cfg = alloc_map.get(c.id, {}).get(tid, {}).get(tt.id, {}) %}
                                  {% set cfg_qty = cfg.get('qty_for_sale', 0) %}
                                  {% set cfg_price = cfg.get('price_gross', 0.0) %}
                                  {% set sold_acum = ticketer_type_totals_map.get(c.id, {}).get(tid, {}).get(tt.id, {}).get('sold', 0) %}
                                  {% set pct_tt = (sold_acum / cfg_qty * 100) if cfg_qty and cfg_qty > 0 else 0 %}
                                  {% set pend_tt = (cfg_qty - sold_acum) if cfg_qty and cfg_qty > sold_acum else 0 %}
                                  {% set today_val = details_today.get(c.id, {}).get(tid, {}).get(tt.id, 0) %}

                                  <tr>
                                    <td>{{ tt.name }}</td>
                                    <td class="text-end">{{ "%.2f"|format(cfg_price or 0.0) }} €</td>
                                    <td class="text-end">
                                      <input
                                        id="qty-{{ c.id }}-{{ tid }}-{{ tt.id }}"
                                        class="form-control form-control-sm text-end"
                                        type="number"
                                        min="0"
                                        step="1"
                                        name="qty_{{ tt.id }}"
                                        value="{{ today_val }}"
                                        
                                      >
                                    </td>
                                    <td class="text-end">{{ sold_acum }}</td>
                                    <td class="text-end">{{ "%.1f"|format(pct_tt) }}%</td>
                                    <td class="text-end">{{ pend_tt }}</td>
                                    <td class="text-end">{{ cfg_qty }}</td>
                                  </tr>
                                {% endfor %}
                              </tbody>
                            </table>
                          </div>

                          <div class="d-flex gap-2 justify-content-end">                            <button id="save-{{ c.id }}-{{ tid }}" class="btn btn-sm btn-primary" type="submit">
                              <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
                            </button>
</div>
                        </form>

                      </div>
                    </div>
                  {% endfor %}
                {% endif %}

              </div>
            </div>
          </div>
        </div>

        {# ---------------- MODAL: CONFIGURACIÓN VENTAS ---------------- #}
        <div class="modal fade" id="cfgModal-{{ c.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <div>
                  <h5 class="modal-title mb-0">Configuración de ventas</h5>
                  <div class="text-muted small">
                    {{ c.artist.name if c.artist else 'Sin artista' }}
                    {% if c.date %} · {{ c.date.strftime('%d/%m/%Y') }}{% endif %}
                  </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
              </div>

              <div class="modal-body">

                {% set original_cap = original_capacity_map.get(c.id, 0) %}
                {% set configured_cap = c.ticket_types|sum(attribute='qty_for_sale') if c.ticket_types else 0 %}

                <div class="row g-3">
                  <div class="col-lg-5">
                    <div class="card">
                      <div class="card-header"><strong>IVA / SGAE</strong></div>
                      <div class="card-body">
                        <form method="post" action="{{ url_for('sales_config_save', cid=c.id) }}">
                          <input type="hidden" name="day" value="{{ day.isoformat() }}">
                          <div class="row g-2">
                            <div class="col-6">
                              <label class="form-label">IVA (%)</label>
                              <input class="form-control" type="number" step="0.01" min="0" name="vat_pct" value="{{ c.sales_config.vat_pct if c.sales_config else '' }}">
                            </div>
                            <div class="col-6">
                              <label class="form-label">SGAE (%)</label>
                              <input class="form-control" type="number" step="0.01" min="0" name="sgae_pct" value="{{ c.sales_config.sgae_pct if c.sales_config else '' }}">
                            </div>
                            <div class="col-12 d-flex justify-content-end mt-2">
                              <button class="btn btn-primary" type="submit">
                                <i class="fa-solid fa-floppy-disk me-1"></i> Guardar
                              </button>
                            </div>
                          </div>
                        </form>

                        <hr>
{% if configured_cap and original_cap and configured_cap != original_cap %}
  <div class="text-warning small">
    <i class="fa-solid fa-triangle-exclamation me-1"></i>
    El aforo configurado ({{ configured_cap }}) no coincide con el aforo original ({{ original_cap }}).
  </div>

  <!-- Modal: mismatch aforo -->
  <div class="modal fade" id="capMismatchModal-{{ c.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aforo configurado no coincide</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            El aforo configurado por tipos (<strong>{{ configured_cap }}</strong>) no coincide con el aforo original del evento (<strong>{{ original_cap }}</strong>).
          </p>
          <p class="mb-0 small text-muted">
            ¿Qué quieres hacer?
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Mantener aforo original</button>
          <form method="post" action="{{ url_for('sales_concert_capacity_update', cid=c.id) }}">
            <input type="hidden" name="day" value="{{ day.isoformat() }}">
            <button class="btn btn-warning" type="submit">Actualizar aforo</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const cfgEl = document.getElementById('cfgModal-{{ c.id }}');
      const mmEl = document.getElementById('capMismatchModal-{{ c.id }}');
      if (!cfgEl || !mmEl) return;

      // Cuando se abre el modal de configuración, mostramos la alerta en pop-up (una vez por carga)
      cfgEl.addEventListener('shown.bs.modal', function () {
        const m = new bootstrap.Modal(mmEl);
        m.show();
      }, { once: true });
    });
  </script>
{% endif %}
                      </div>
                    </div>
                  </div>

                  <div class="col-lg-7">
                    <div class="card">
                      <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Tipos de entrada</strong>
                        <span class="text-muted small">Aforo total a la venta: {{ configured_cap }}</span>
                      </div>

                      <div class="card-body">
                        <form class="row g-2 align-items-end mb-3" method="post" action="{{ url_for('sales_ticket_type_add', cid=c.id) }}">
                          <input type="hidden" name="day" value="{{ day.isoformat() }}">
                          <div class="col-md-6">
                            <label class="form-label">Tipo</label>
                            <input class="form-control" name="type_name" placeholder="General / VIP / ...">
                          </div>
                          <div class="col-md-3">
                            <label class="form-label">Aforo total</label>
                            <input class="form-control" type="number" min="0" step="1" name="type_qty" value="0">
                          </div>
                          <div class="col-md-3 d-flex justify-content-end">
                            <button class="btn btn-outline-primary" type="submit">
                              <i class="fa-solid fa-plus me-1"></i> Añadir
                            </button>
                          </div>
                        </form>

                        <div class="table-responsive">
                          <table class="table table-sm align-middle">
                            <thead>
                              <tr>
                                <th>Tipo / Aforo total</th>
                                <th class="text-end">Faltan por configurar</th>
                                <th class="text-end">Acciones</th>
                              </tr>
                            </thead>
                            <tbody>
                              {% for tt in c.ticket_types %}
                                {% set missing = type_missing_map.get(c.id, {}).get(tt.id, 0) %}
                                <tr>
                                  <td>
                                    <form class="d-flex gap-2" method="post" action="{{ url_for('sales_ticket_type_update', cid=c.id, ttid=tt.id) }}">
                                      <input type="hidden" name="day" value="{{ day.isoformat() }}">
                                      <input class="form-control form-control-sm" name="type_name" value="{{ tt.name }}">
                                      <input class="form-control form-control-sm text-end" style="max-width:120px" type="number" min="0" step="1" name="type_qty" value="{{ tt.qty_for_sale }}">
                                      <button class="btn btn-sm btn-primary" type="submit" title="Guardar">
                                        <i class="fa-solid fa-floppy-disk"></i>
                                      </button>
                                    </form>
                                  </td>
                                  <td class="text-end">
                                    <span class="{% if missing < 0 %}text-danger{% elif missing > 0 %}text-warning{% else %}text-success{% endif %}">
                                      {{ missing }}
                                    </span>
                                  </td>
                                  <td class="text-end">
                                    <form method="post" action="{{ url_for('sales_ticket_type_delete', cid=c.id, ttid=tt.id) }}" onsubmit="return confirm('¿Eliminar tipo de entrada?')">
                                      <input type="hidden" name="day" value="{{ day.isoformat() }}">
                                      <button class="btn btn-sm btn-outline-danger" type="submit">
                                        <i class="fa-solid fa-trash"></i>
                                      </button>
                                    </form>
                                  </td>
                                </tr>
                              {% endfor %}
                            </tbody>
                          </table>
                        </div>

                        <div class="small text-muted">
                          Nota: <strong>Faltan por configurar</strong> se calcula como (aforo del tipo) − (suma de cupos en todas las ticketeras).
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <hr class="my-4">

                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0">Ticketeras</h6>
                  <form class="d-flex gap-2" method="post" action="{{ url_for('sales_ticketer_add', cid=c.id) }}">
                    <input type="hidden" name="day" value="{{ day.isoformat() }}">
                    <select class="form-select form-select-sm select-with-thumbs" name="ticketer_id" style="min-width:220px">
                      <option value="">— Selecciona —</option>
                      {% for t in all_ticketers %}
                        <option value="{{ t.id }}" data-photo="{{ t.logo_url or url_for('static', filename='img/default_promoter.png') }}">{{ t.name }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-sm btn-outline-primary" type="submit">
                      <i class="fa-solid fa-plus me-1"></i> Añadir
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openNewTicketerModal('{{ c.id }}')">
                      Nueva
                    </button>
                  </form>
                </div>

                {% if not c.ticketers %}
                  <div class="alert alert-secondary">No hay ticketeras configuradas para este evento.</div>
                {% endif %}

                <div class="accordion" id="ticketersAcc-{{ c.id }}">
                  {% for ct in c.ticketers %}
                    {% set tid = ct.ticketer_id %}
                    {% set tcap = ticketer_capacity_cfg_map.get(c.id, {}).get(tid, 0) %}
                    {% set is_open_tick = (open_cfg == c.id|string and open_ticketer == tid|string) %}
                    <div class="accordion-item">
                      <h2 class="accordion-header" id="tickh-{{ c.id }}-{{ tid }}">
                        <button class="accordion-button {% if not is_open_tick %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#tickc-{{ c.id }}-{{ tid }}" aria-expanded="{% if is_open_tick %}true{% else %}false{% endif %}" aria-controls="tickc-{{ c.id }}-{{ tid }}">
                          <img src="{{ ct.ticketer.logo_url or url_for('static', filename='img/default_promoter.png') }}" class="station-logo me-2" style="width:20px;height:20px;object-fit:contain;" alt="">
                          <strong class="me-2">{{ ct.ticketer.name }}</strong>
                          <span class="text-muted small">Aforo a la venta: {{ tcap }}</span>
                        </button>
                      </h2>
                      <div id="tickc-{{ c.id }}-{{ tid }}" class="accordion-collapse collapse {% if is_open_tick %}show{% endif %}" aria-labelledby="tickh-{{ c.id }}-{{ tid }}" data-bs-parent="#ticketersAcc-{{ c.id }}">
                        <div class="accordion-body">

                          <div class="d-flex justify-content-end mb-2">
                            <form method="post" action="{{ url_for('sales_ticketer_remove', cid=c.id, tid=tid) }}" onsubmit="return confirm('¿Eliminar ticketera del evento?')">
                              <input type="hidden" name="day" value="{{ day.isoformat() }}">
                              <button class="btn btn-sm btn-outline-danger" type="submit">
                                <i class="fa-solid fa-trash me-1"></i> Quitar ticketera
                              </button>
                            </form>
                          </div>

                          <form method="post" action="{{ url_for('sales_ticketer_allocations_save', cid=c.id, tid=tid) }}">
                            <input type="hidden" name="day" value="{{ day.isoformat() }}">

                            <div class="table-responsive">
                              <table class="table table-sm align-middle">
                                <thead>
                                  <tr>
                                    <th>Tipo</th>
                                    <th class="text-end">Entradas a vender</th>
                                    <th class="text-end">Precio bruto</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  {% for tt in c.ticket_types %}
                                    {% set cfg = alloc_map.get(c.id, {}).get(tid, {}).get(tt.id, {}) %}
                                    <tr>
                                      <td>{{ tt.name }}</td>
                                      <td class="text-end" style="max-width: 160px;">
                                        <input class="form-control form-control-sm text-end" type="number" min="0" step="1"
                                          name="alloc_qty_{{ tt.id }}"
                                          value="{{ cfg.get('qty_for_sale', 0) }}">
                                      </td>
                                      <td class="text-end" style="max-width: 180px;">
                                        <input class="form-control form-control-sm text-end" type="number" min="0" step="0.01"
                                          name="alloc_price_{{ tt.id }}"
                                          value="{{ "%.2f"|format(cfg.get('price_gross', 0.0) or 0.0) }}">
                                      </td>
                                    </tr>
                                  {% endfor %}
                                </tbody>
                              </table>
                            </div>

                            <div class="d-flex justify-content-end">
                              <button class="btn btn-sm btn-primary" type="submit">
                                <i class="fa-solid fa-floppy-disk me-1"></i> Guardar configuración
                              </button>
                            </div>
                          </form>

                          <hr>

                          {# Rebate #}
                          <div class="d-flex justify-content-between align-items-center">
                            <div>
                              <strong>Rebate</strong>
                              <div class="text-muted small">Se muestra como ingreso separado (neto, sin IVA 21%).</div>
                            </div>
                            <div class="d-flex gap-2">
                              {% if ct.rebate_mode %}
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                        onclick="openRebateModal(this)"
                                        data-concert-id="{{ c.id }}"
                                        data-ticketer-id="{{ tid }}"
                                        data-action="{{ url_for('sales_ticketer_rebate_save', cid=c.id, tid=tid) }}"
                                        data-ticketer-name="{{ ct.ticketer.name }}"
                                        data-ticketer-logo="{{ ct.ticketer.logo_url or url_for('static', filename='img/default_promoter.png') }}"
                                        data-rebate-mode="{{ ct.rebate_mode or '' }}"
                                        data-rebate-fixed="{{ '%.2f'|format(ct.rebate_fixed_gross or 0.0) }}"
                                        data-rebate-pct="{{ '%.2f'|format(ct.rebate_pct or 0.0) }}">
                                  Editar rebate
                                </button>
                                <form method="post" action="{{ url_for('sales_ticketer_rebate_delete', cid=c.id, tid=tid) }}" onsubmit="return confirm('¿Eliminar rebate?')">
                                  <input type="hidden" name="day" value="{{ day.isoformat() }}">
                                  <button class="btn btn-sm btn-outline-danger" type="submit">Eliminar</button>
                                </form>
                              {% else %}
                                <button class="btn btn-sm btn-outline-primary" type="button"
                                        onclick="openRebateModal(this)"
                                        data-concert-id="{{ c.id }}"
                                        data-ticketer-id="{{ tid }}"
                                        data-action="{{ url_for('sales_ticketer_rebate_save', cid=c.id, tid=tid) }}"
                                        data-ticketer-name="{{ ct.ticketer.name }}"
                                        data-ticketer-logo="{{ ct.ticketer.logo_url or url_for('static', filename='img/default_promoter.png') }}"
                                        data-rebate-mode="{{ ct.rebate_mode or '' }}"
                                        data-rebate-fixed="{{ '%.2f'|format(ct.rebate_fixed_gross or 0.0) }}"
                                        data-rebate-pct="{{ '%.2f'|format(ct.rebate_pct or 0.0) }}">
                                  Añadir rebate
                                </button>
                              {% endif %}
                            </div>
                          </div>

                          {% if ct.rebate_mode %}
                            <div class="mt-2 small">
                              {% if ct.rebate_mode == 'FIXED' %}
                                <span class="badge bg-light text-dark border">Fijo</span>
                                <span class="ms-2">Importe por entrada (bruto): <strong>{{ "%.2f"|format(ct.rebate_fixed_gross or 0.0) }} €</strong></span>
                              {% elif ct.rebate_mode == 'PERCENT' %}
                                <span class="badge bg-light text-dark border">% Venta</span>
                                <span class="ms-2">Porcentaje: <strong>{{ "%.2f"|format(ct.rebate_pct or 0.0) }}%</strong></span>
                              {% endif %}
                            </div>
                          {% endif %}

                        </div>
                      </div>
                    </div>

                  {% endfor %}
                </div>

              </div>

              <div class="modal-footer">
                <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cerrar</button>
              </div>

            </div>
          </div>
        </div>

      {% endfor %}
    </div>
  {% endif %}
{% endfor %}

{# ---------------- MODAL: GENERAR INFORME (AVANZADO) ---------------- #}
<div class="modal fade" id="salesReportModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0">Generar informe</h5>
          <div class="text-muted small">Reporte de ventas — {{ day.strftime('%d/%m/%Y') }}</div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <form method="get" action="{{ url_for('sales_update_report_pdf') }}" target="_blank">
          <input type="hidden" name="d" value="{{ day.isoformat() }}">

          <div class="mb-3">
            <label class="form-label">Artistas</label>
            <select class="form-select select-artists" name="artist_ids" multiple>
              {% for a in report_artists %}
                <option value="{{ a.id }}" data-photo="{{ a.photo_url or url_for('static', filename='img/logo.png') }}" selected>{{ a.name }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Por defecto se incluyen todos los artistas visibles en este día.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Campos del informe</label>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="date" id="f_date" checked>
                  <label class="form-check-label" for="f_date">Fecha del evento</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="artist" id="f_artist" checked>
                  <label class="form-check-label" for="f_artist">Artista</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="city" id="f_city" checked>
                  <label class="form-check-label" for="f_city">Municipio</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="province" id="f_prov" checked>
                  <label class="form-check-label" for="f_prov">Provincia</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="venue" id="f_venue" checked>
                  <label class="form-check-label" for="f_venue">Recinto</label>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="sold_total" id="f_sold_total" checked>
                  <label class="form-check-label" for="f_sold_total">Vendidas (total)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="sold_today" id="f_sold_today" checked>
                  <label class="form-check-label" for="f_sold_today">Vendidas (hoy)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="capacity" id="f_cap" checked>
                  <label class="form-check-label" for="f_cap">Aforo a la venta</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="pct" id="f_pct" checked>
                  <label class="form-check-label" for="f_pct">% venta</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="pending" id="f_pending" checked>
                  <label class="form-check-label" for="f_pending">Pendientes</label>
                </div>
                {% if CAN_VIEW_ECON %}
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="fields" value="gross" id="f_gross" checked>
                    <label class="form-check-label" for="f_gross">Bruto</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="fields" value="net" id="f_net" checked>
                    <label class="form-check-label" for="f_net">Neto</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="fields" value="rebate_net" id="f_rebate" checked>
                    <label class="form-check-label" for="f_rebate">Rebate neto</label>
                  </div>
                {% endif %}
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="fields" value="updated" id="f_updated" checked>
                  <label class="form-check-label" for="f_updated">Última actualización</label>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-primary" type="submit">
              <i class="fa-solid fa-file-pdf me-1"></i> Generar
            </button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{# ---------------- MODAL: NUEVA TICKETERA ---------------- #}
<div class="modal fade" id="newTicketerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="newTicketerForm">
      <div class="modal-header">
        <h5 class="modal-title">Nueva ticketera</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Nombre</label>
        <input class="form-control" name="name" required>
        <div class="form-text">Se creará la ticketera y aparecerá en el selector.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" type="submit">Crear</button>
        <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
      </div>
    </form>
  </div>
</div>

{# ---------------- MODAL: REBATE (GLOBAL) ---------------- #}
<div class="modal fade" id="rebateModalGlobal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title d-flex align-items-center gap-2">
          <img id="rebateModalLogo" src="{{ url_for('static', filename='img/default_promoter.png') }}" style="width:20px;height:20px;object-fit:contain;" alt="">
          <span id="rebateModalTitle">Configurar rebate</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form method="post" id="rebateModalForm" action="">
          <input type="hidden" name="day" value="{{ day.isoformat() }}">

          <div class="mb-2">
            <label class="form-label">Tipo de rebate</label>
            <select class="form-select" name="rebate_mode" id="rebateModeSel" onchange="toggleRebateFields()">
              <option value="">— Sin rebate —</option>
              <option value="FIXED">Importe fijo por entrada vendida (bruto, IVA 21% incluido)</option>
              <option value="PERCENT">Porcentaje sobre ingresos base (sin IVA)</option>
            </select>
          </div>

          <div class="mb-2" id="rebateFixedWrap">
            <label class="form-label">Importe fijo por entrada (bruto)</label>
            <input class="form-control" type="number" step="0.01" min="0" name="rebate_fixed_gross" id="rebateFixedInput" value="0">
          </div>

          <div class="mb-2" id="rebatePctWrap">
            <label class="form-label">Porcentaje (%)</label>
            <input class="form-control" type="number" step="0.01" min="0" max="100" name="rebate_pct" id="rebatePctInput" value="0">
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-primary" type="submit">Guardar</button>
            <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Cancelar</button>
          </div>

          <div class="form-text mt-2">
            El rebate se calcula y muestra como ingreso separado en <strong>neto</strong> (sin IVA 21%).
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>

// Abrir modal de rebate sin "congelar" la pantalla (Bootstrap no soporta modales anidados)
function openRebateModal(btn) {
  if (!btn) return;

  const concertId = (btn.dataset.concertId || '').trim();
  const ticketerId = (btn.dataset.ticketerId || '').trim();
  const action = (btn.dataset.action || '').trim();
  const ticketerName = (btn.dataset.ticketerName || '').trim();
  const ticketerLogo = (btn.dataset.ticketerLogo || '').trim();
  const mode = (btn.dataset.rebateMode || '').toUpperCase();
  const fixed = (btn.dataset.rebateFixed || '0').trim();
  const pct = (btn.dataset.rebatePct || '0').trim();

  const rebateEl = document.getElementById('rebateModalGlobal');
  const formEl = document.getElementById('rebateModalForm');
  const titleEl = document.getElementById('rebateModalTitle');
  const logoEl = document.getElementById('rebateModalLogo');
  const sel = document.getElementById('rebateModeSel');
  const fixedInput = document.getElementById('rebateFixedInput');
  const pctInput = document.getElementById('rebatePctInput');

  if (!rebateEl || !formEl || !sel) return;

  // Guardamos a qué modal de configuración debemos volver
  rebateEl.dataset.returnConcertId = concertId;
  rebateEl.dataset.returnTicketerId = ticketerId;

  if (action) formEl.action = action;
  if (titleEl) titleEl.textContent = 'Configurar rebate — ' + (ticketerName || 'Ticketera');
  if (logoEl && ticketerLogo) {
    logoEl.src = ticketerLogo;
    logoEl.alt = ticketerName;
  }

  // Valores
  sel.value = mode || '';
  if (fixedInput) fixedInput.value = fixed;
  if (pctInput) pctInput.value = pct;
  toggleRebateFields();

  const rebateModal = bootstrap.Modal.getInstance(rebateEl) || new bootstrap.Modal(rebateEl);
  const cfgEl = concertId ? document.getElementById('cfgModal-' + concertId) : null;

  if (cfgEl) {
    const cfgModal = bootstrap.Modal.getInstance(cfgEl) || new bootstrap.Modal(cfgEl);
    cfgModal.hide();
    cfgEl.addEventListener('hidden.bs.modal', function _once() {
      cfgEl.removeEventListener('hidden.bs.modal', _once);
      rebateModal.show();
    }, { once: true });
  } else {
    rebateModal.show();
  }
}

function toggleRebateFields() {
  const sel = document.getElementById('rebateModeSel');
  const fixedWrap = document.getElementById('rebateFixedWrap');
  const pctWrap = document.getElementById('rebatePctWrap');
  if (!sel) return;
  const v = (sel.value || '').toUpperCase();
  if (fixedWrap) fixedWrap.style.display = (v === 'FIXED') ? 'block' : 'none';
  if (pctWrap) pctWrap.style.display = (v === 'PERCENT') ? 'block' : 'none';
}

// Al cerrar el modal de rebate, reabrimos la configuración del concierto y hacemos scroll a la ticketera
document.addEventListener('DOMContentLoaded', function () {
  const rebateEl = document.getElementById('rebateModalGlobal');
  if (rebateEl) {
    rebateEl.addEventListener('hidden.bs.modal', function () {
      const cid = (rebateEl.dataset.returnConcertId || '').trim();
      const tid = (rebateEl.dataset.returnTicketerId || '').trim();
      if (!cid) return;
      const cfgEl = document.getElementById('cfgModal-' + cid);
      if (!cfgEl) return;

      cfgEl.addEventListener('shown.bs.modal', function _onceShow() {
        cfgEl.removeEventListener('shown.bs.modal', _onceShow);
        if (tid) {
          const acc = document.getElementById('tickh-' + cid + '-' + tid);
          if (acc) acc.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, { once: true });

      (bootstrap.Modal.getInstance(cfgEl) || new bootstrap.Modal(cfgEl)).show();
    });
  }

  // Estado inicial de campos
  toggleRebateFields();
});

// Abrir modal "Nueva ticketera" sin anidar modales y conservando el concierto activo
function openNewTicketerModal(concertId) {
  const cfgEl = document.getElementById('cfgModal-' + concertId);
  const ntEl = document.getElementById('newTicketerModal');
  const form = document.getElementById('newTicketerForm');
  if (!ntEl || !form) return;

  form.dataset.concertId = concertId || '';

  // Si venimos desde un modal de configuración, lo ocultamos primero
  if (cfgEl) {
    const cfgModal = bootstrap.Modal.getInstance(cfgEl) || new bootstrap.Modal(cfgEl);
    cfgModal.hide();
    cfgEl.addEventListener('hidden.bs.modal', function _once() {
      cfgEl.removeEventListener('hidden.bs.modal', _once);
      (bootstrap.Modal.getInstance(ntEl) || new bootstrap.Modal(ntEl)).show();
    });
    ntEl.addEventListener('hidden.bs.modal', function _once2() {
      ntEl.removeEventListener('hidden.bs.modal', _once2);
      (bootstrap.Modal.getInstance(cfgEl) || new bootstrap.Modal(cfgEl)).show();
    });
  } else {
    (bootstrap.Modal.getInstance(ntEl) || new bootstrap.Modal(ntEl)).show();
  }
}

  // Crear ticketera (AJAX)
  const newTicketerForm = document.getElementById('newTicketerForm');
  if (newTicketerForm) newTicketerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const name = form.name.value.trim();
    if (!name) return;

    try {
      const res = await fetch("{{ url_for('api_create_ticketer') }}", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({name})
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Error creando ticketera");

      // Recargar página para que el selector se actualice (manteniendo el día y reabriendo configuración)
      const baseUrl = "{{ url_for('sales_update_view', d=day.isoformat()) }}";
      const cid = (form.dataset.concertId || "").trim();
      let url = baseUrl;
      if (cid) {
        url += (url.includes("?") ? "&" : "?") + "open_cfg=" + encodeURIComponent(cid);
      }
      window.location.href = url;
    } catch (err) {
      alert(err.message || err);
    }
  });

  // Reabrir modales tras POST (para que no "salte" de pantalla)
  document.addEventListener('DOMContentLoaded', function () {
    const openCfg = "{{ open_cfg }}";
    const openTicketer = "{{ open_ticketer }}";
    if (openCfg) {
      const el = document.getElementById('cfgModal-' + openCfg);
      if (el) {
        el.addEventListener('shown.bs.modal', function() {
          if (openTicketer) {
            const acc = document.getElementById('tickh-' + openCfg + '-' + openTicketer);
            if (acc) acc.scrollIntoView({behavior: 'smooth', block: 'start'});
          }
        }, {once: true});
        new bootstrap.Modal(el).show();
      }
    }

    const openSales = "{{ open_sales }}";
    if (openSales) {
      const el2 = document.getElementById('salesUpdateModal-' + openSales);
      if (el2) new bootstrap.Modal(el2).show();
    }
  });
</script>

{% endblock %}
