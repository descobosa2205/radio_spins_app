{% extends "layout.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="d-flex align-items-center gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('concerts_view', tab='vista') }}#concert-{{ c.id }}">
      <i class="fa fa-chevron-left"></i>
    </a>
    <h4 class="m-0">Editar concierto</h4>
  </div>
  <div class="badge bg-light text-dark px-3 py-2">
    {{ c.artist.name if c.artist else '—' }} — {{ c.date.strftime('%d/%m/%Y') if c.date else '—' }}
  </div>
</div>

<div class="card">
  <div class="card-body">

    <form method="post" action="{{ url_for('concert_update', cid=c.id) }}" enctype="multipart/form-data" class="row g-2">

      <!-- fila 1 -->
      <div class="col-md-2">
        <label class="form-label">Fecha</label>
        <input type="date" name="date" class="form-control" required
               value="{{ c.date.isoformat() if c.date }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Estado</label>
        <select name="status" class="form-select" required>
          <option value="HABLADO" {% if (c.status or '').upper() == 'HABLADO' %}selected{% endif %}>Hablado</option>
          <option value="RESERVADO" {% if (c.status or '').upper() == 'RESERVADO' %}selected{% endif %}>Reservado</option>
          <option value="CONFIRMADO" {% if (c.status or '').upper() == 'CONFIRMADO' %}selected{% endif %}>Confirmado</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Artista</label>
        <select name="artist_id" class="form-select" required>
          {% for a in artists %}
            <option value="{{ a.id }}" {% if a.id == c.artist_id %}selected{% endif %}>{{ a.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Nombre del evento (opcional)</label>
        <input name="festival_name" class="form-control" value="{{ c.festival_name or '' }}">
      </div>

      <!-- fila 2 -->
      <div class="col-md-6">
        <label class="form-label">Recinto</label>
        <div class="input-group">
          {% set venue_label = (c.venue.name ~ ' — ' ~ (c.venue.municipality or '') ~ ' ' ~ (c.venue.province or '')) if c.venue else '' %}
          <input id="venue_search_edit" class="form-control" value="{{ venue_label.strip() }}" placeholder="Buscar recinto...">
          <input id="venue_id_edit" type="hidden" name="venue_id" value="{{ c.venue_id }}">
          <button class="btn btn-outline-secondary" type="button" onclick="openVenueModal({mode:'typeahead', inputId:'venue_search_edit', hiddenId:'venue_id_edit'})">
            <i class="fa fa-plus"></i>
          </button>
        </div>
        <div class="form-text">Si no aparece en el buscador, créalo con el botón +.</div>
      </div>

      <div class="col-md-3">
        <label class="form-label">Tipo de concierto</label>
        <select name="sale_type" id="sale_type_edit" class="form-select" required onchange="refreshTypeUIEdit()">
          <option value="PARTICIPADOS" {% if c.sale_type == 'PARTICIPADOS' %}selected{% endif %}>Participado</option>
          <option value="EMPRESA" {% if c.sale_type == 'EMPRESA' %}selected{% endif %}>Empresa</option>
          <option value="VENDIDO" {% if c.sale_type == 'VENDIDO' %}selected{% endif %}>Vendido</option>
          <option value="CADIZ" {% if c.sale_type == 'CADIZ' %}selected{% endif %}>Cádiz Music Stadium</option>
        </select>
      </div>

      <div class="col-md-3" id="company_wrap_edit" style="display:none;">
        <label class="form-label">Empresa del grupo (gestión)</label>
        <select name="group_company_id" class="form-select">
          <option value="">—</option>
          {% for co in companies %}
            <option value="{{ co.id }}" {% if co.id == c.group_company_id %}selected{% endif %}>{{ co.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6" id="promoter_wrap_edit" style="display:none;">
        <label class="form-label">Tercero principal (vendido)</label>
        <div class="input-group">
          <input id="promoter_search_edit" class="form-control" placeholder="Buscar tercero..." value="{{ c.promoter.nick if c.promoter else '' }}">
          <input id="promoter_id_edit" type="hidden" name="promoter_id" value="{{ c.promoter_id or '' }}">
          <button class="btn btn-outline-secondary" type="button" onclick="openPromoterModal({mode:'typeahead', inputId:'promoter_search_edit', hiddenId:'promoter_id_edit'})">
            <i class="fa fa-plus"></i>
          </button>
        </div>
        <div class="form-text">Si no aparece, créalo con el botón +.</div>
      </div>

      <!-- fila 3 -->
      <div class="col-md-2">
        <label class="form-label">Aforo a la venta</label>
        <input type="number" name="capacity" class="form-control" required value="{{ c.capacity }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Salida a la venta</label>
        <input type="date" name="sale_start_date" class="form-control" required
               value="{{ c.sale_start_date.isoformat() if c.sale_start_date }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Punto de empate (opcional)</label>
        <input type="number" name="break_even_ticket" class="form-control"
               value="{{ c.break_even_ticket if c.break_even_ticket }}">
      </div>

      <!-- ===== COLABORADORES ===== -->
      <div class="col-12 mt-2">
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Participación de terceros</strong>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openPromoterModal(null)">
                <i class="fa fa-plus"></i> Crear tercero
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addThirdPartyRowEdit()">
                <i class="fa fa-plus"></i> Añadir
              </button>
            </div>
          </div>
          <div id="third_party_rows_edit" class="row g-2">
            {% for s in c.promoter_shares %}
              <div class="col-12 d-flex flex-wrap align-items-end gap-2 third-party-row">
                <div style="min-width:260px;" class="flex-grow-1">
                  <label class="form-label">Tercero</label>
                  <select name="promoter_share_id[]" class="form-select third-party-select">
                    <option value="">—</option>
                    {% for p in promoters %}
                      <option value="{{ p.id }}" {% if p.id == s.promoter_id %}selected{% endif %}>{{ p.nick }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div style="width:140px;">
                  <label class="form-label">% </label>
                  <input type="number" name="promoter_share_pct[]" class="form-control" min="0" max="100"
                         value="{{ s.pct if s.pct }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base %</label>
                  <select name="promoter_share_pct_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (s.pct_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (s.pct_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <div style="width:160px;">
                  <label class="form-label">Fijo (€)</label>
                  <input type="number" step="0.01" name="promoter_share_amount[]" class="form-control"
                         value="{{ s.amount if s.amount }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base fijo</label>
                  <select name="promoter_share_amount_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (s.amount_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (s.amount_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.third-party-row').remove()">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            {% endfor %}
          </div>
          {% if (c.promoter_shares|length) == 0 %}
            <div class="text-muted"><small>Opcional. Si no añades nada, no se mostrará en la ficha.</small></div>
          {% endif %}
        </div>
      </div>

      <div class="col-12 mt-2">
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Participación de empresas</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCompanyRowEdit()">
              <i class="fa fa-plus"></i> Añadir
            </button>
          </div>
          <div id="company_rows_edit" class="row g-2">
            {% for s in c.company_shares %}
              <div class="col-12 d-flex flex-wrap align-items-end gap-2 company-row">
                <div style="min-width:260px;" class="flex-grow-1">
                  <label class="form-label">Empresa</label>
                  <select name="company_share_id[]" class="form-select">
                    <option value="">—</option>
                    {% for co in companies %}
                      <option value="{{ co.id }}" {% if co.id == s.company_id %}selected{% endif %}>{{ co.name }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div style="width:140px;">
                  <label class="form-label">% </label>
                  <input type="number" name="company_share_pct[]" class="form-control" min="0" max="100"
                         value="{{ s.pct if s.pct }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base %</label>
                  <select name="company_share_pct_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (s.pct_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (s.pct_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <div style="width:160px;">
                  <label class="form-label">Fijo (€)</label>
                  <input type="number" step="0.01" name="company_share_amount[]" class="form-control"
                         value="{{ s.amount if s.amount }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base fijo</label>
                  <select name="company_share_amount_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (s.amount_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (s.amount_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.company-row').remove()">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            {% endfor %}
          </div>
          {% if (c.company_shares|length) == 0 %}
            <div class="text-muted"><small>Opcional. Si no añades nada, no se mostrará en la ficha.</small></div>
          {% endif %}
        </div>
      </div>

      <div class="col-12 mt-2">
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Promotores de zona (comisionistas)</strong>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="openPromoterModal(null)">
                <i class="fa fa-plus"></i> Crear tercero
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addZoneRowEdit()">
                <i class="fa fa-plus"></i> Añadir
              </button>
            </div>
          </div>

          <div id="zone_rows_edit" class="row g-2">
            {% for s in c.zone_agents %}
              <div class="col-12 d-flex flex-wrap align-items-end gap-2 zone-row">
                <div style="min-width:260px;" class="flex-grow-1">
                  <label class="form-label">Tercero</label>
                  <select name="zone_promoter_id[]" class="form-select zone-party-select">
                    <option value="">—</option>
                    {% for p in promoters %}
                      <option value="{{ p.id }}" {% if p.id == s.promoter_id %}selected{% endif %}>{{ p.nick }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div style="width:160px;">
                  <label class="form-label">% comisión</label>
                  <input type="number" step="0.01" name="zone_commission_pct[]" class="form-control"
                         value="{{ s.commission_pct if s.commission_pct }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base %</label>
                  <select name="zone_commission_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (s.commission_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (s.commission_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <div style="width:160px;">
                  <label class="form-label">Fijo (€)</label>
                  <input type="number" step="0.01" name="zone_commission_amount[]" class="form-control"
                         value="{{ s.commission_amount if s.commission_amount }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base fijo</label>
                  <select name="zone_commission_amount_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (s.commission_amount_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (s.commission_amount_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.zone-row').remove()">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            {% endfor %}
          </div>
          {% if (c.zone_agents|length) == 0 %}
            <div class="text-muted"><small>Opcional. Si no añades nada, no se mostrará en la ficha.</small></div>
          {% endif %}
        </div>
      </div>

      <!-- ===== CACHÉS ===== -->
      <div class="col-12 mt-2">
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Cachés</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCacheRowEdit()">
              <i class="fa fa-plus"></i> Añadir
            </button>
          </div>

          <div id="cache_rows_edit" class="row g-2">
            {% for ch in c.caches %}
              <div class="col-12 d-flex flex-wrap align-items-end gap-2 cache-row">
                <div style="width:160px;">
                  <label class="form-label">Tipo</label>
                  <select name="cache_kind[]" class="form-select" onchange="onCacheKindChange(this)">
                    <option value="FIXED" {% if (ch.kind or '').upper() == 'FIXED' %}selected{% endif %}>Fijo</option>
                    <option value="VARIABLE" {% if (ch.kind or '').upper() == 'VARIABLE' %}selected{% endif %}>Variable</option>
                    <option value="OTHER" {% if (ch.kind or '').upper() == 'OTHER' %}selected{% endif %}>Otros</option>
                  </select>
                </div>

                <div style="width:180px;" data-cache-variable-wrap>
                  <label class="form-label">Variable</label>
                  <select name="cache_variable_basis[]" class="form-select">
                    <option value="">—</option>
                    <option value="TICKETS" {% if (ch.variable_basis or '').upper() == 'TICKETS' %}selected{% endif %}>Por entradas</option>
                    <option value="REVENUE" {% if (ch.variable_basis or '').upper() == 'REVENUE' %}selected{% endif %}>Por recaudación</option>
                  </select>
                </div>

                <div style="min-width:220px;" class="flex-grow-1" data-cache-concept-wrap>
                  <label class="form-label">Concepto (otros)</label>
                  <input name="cache_concept[]" class="form-control" value="{{ ch.concept or '' }}">
                </div>

                <div style="width:140px;">
                  <label class="form-label">% </label>
                  <input type="number" step="0.01" name="cache_pct[]" class="form-control" value="{{ ch.pct if ch.pct }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base %</label>
                  <select name="cache_pct_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (ch.pct_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (ch.pct_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <div style="width:160px;">
                  <label class="form-label">Fijo (€)</label>
                  <input type="number" step="0.01" name="cache_amount[]" class="form-control" value="{{ ch.amount if ch.amount }}">
                </div>
                <div style="width:140px;">
                  <label class="form-label">Base fijo</label>
                  <select name="cache_amount_base[]" class="form-select">
                    <option value="">—</option>
                    <option value="GROSS" {% if (ch.amount_base or '').upper() == 'GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if (ch.amount_base or '').upper() == 'NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>

                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.cache-row').remove()">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            {% endfor %}
          </div>

          {% if (c.caches|length) == 0 %}
            <div class="text-muted"><small>Opcional. Si no añades nada, no se mostrará en la ficha.</small></div>
          {% endif %}
        </div>
      </div>

      <!-- ===== CONTRATOS ===== -->
      <div class="col-12 mt-2">
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Contratos</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addContractRowEdit()">
              <i class="fa fa-plus"></i> Añadir
            </button>
          </div>

          {% if c.contracts and (c.contracts|length) > 0 %}
            <div class="mb-2">
              <ul class="list-group">
                {% for ct in c.contracts %}
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <div class="fw-semibold">{{ ct.concept }}</div>
                      <div class="text-muted"><small>Subido: {{ ct.uploaded_at.strftime('%d/%m/%Y') if ct.uploaded_at else '' }}</small></div>
                    </div>
                    <a class="btn btn-sm btn-outline-primary" href="{{ ct.pdf_url }}" target="_blank">
                      <i class="fa fa-file-pdf"></i> Ver
                    </a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="text-muted"><small>Este concierto todavía no tiene contratos adjuntos.</small></div>
          {% endif %}

          <div id="contract_rows_edit" class="row g-2 mt-2"></div>

          <div class="form-text">Para añadir nuevos contratos: agrega filas, selecciona PDF y guarda.</div>
        </div>
      </div>

      <!-- acciones -->
      <div class="col-12 d-flex justify-content-end gap-2 mt-2">
        <button class="btn btn-primary">Guardar cambios</button>
        <form method="post" action="{{ url_for('concert_delete', cid=c.id) }}" onsubmit="return confirm('¿Seguro que quieres borrar este concierto?');">
          <button class="btn btn-outline-danger"><i class="fa fa-trash"></i> Borrar</button>
        </form>
      </div>

    </form>

  </div>
</div>

<!-- ====== Modales (Recinto / Tercero) ====== -->
<div class="modal fade" id="modalNewVenue" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Crear recinto</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="venueModalError" class="alert alert-danger d-none"></div>
        <form id="formNewVenue">
          <div class="mb-2">
            <label class="form-label">Nombre</label>
            <input name="name" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Dirección</label>
            <input name="address" class="form-control">
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Ciudad</label>
              <input name="municipality" class="form-control">
            </div>
            <div class="col-md-6">
              <label class="form-label">Provincia</label>
              <input name="province" class="form-control">
            </div>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="covered" id="coveredEdit">
            <label class="form-check-label" for="coveredEdit">Cubierto</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="button" onclick="submitNewVenue()">Crear</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalNewPromoter" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Crear tercero</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="promoterModalError" class="alert alert-danger d-none"></div>
        <form id="formNewPromoter" enctype="multipart/form-data">
          <div class="mb-2">
            <label class="form-label">Nombre</label>
            <input name="nick" class="form-control" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Logo (PNG)</label>
            <input type="file" name="logo" accept="image/png" class="form-control">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" type="button" onclick="submitNewPromoter()">Crear</button>
      </div>
    </div>
  </div>
</div>

<script>
// ===== Typeahead =====
document.addEventListener('DOMContentLoaded', function(){
  if (typeof initTypeahead === 'function') {
    initTypeahead('venue_search_edit', 'venue_id_edit', '/api/search/venues');
    initTypeahead('promoter_search_edit', 'promoter_id_edit', '/api/search/promoters');
  }
  refreshTypeUIEdit();

  // ajustar UI de filas de cachés existentes
  document.querySelectorAll('#cache_rows_edit .cache-row select[name="cache_kind[]"]').forEach(sel => onCacheKindChange(sel));
});

function refreshTypeUIEdit(){
  const v = (document.getElementById('sale_type_edit')?.value || '').toUpperCase();
  document.getElementById('company_wrap_edit').style.display = (v === 'EMPRESA') ? '' : 'none';
  document.getElementById('promoter_wrap_edit').style.display = (v === 'VENDIDO') ? '' : 'none';
}

function onCacheKindChange(sel){
  const row = sel.closest('.cache-row');
  if(!row) return;
  const kind = (sel.value || '').toUpperCase();
  const varWrap = row.querySelector('[data-cache-variable-wrap]');
  const conceptWrap = row.querySelector('[data-cache-concept-wrap]');
  if(varWrap) varWrap.style.display = (kind === 'VARIABLE') ? '' : 'none';
  if(conceptWrap) conceptWrap.style.display = (kind === 'OTHER') ? '' : 'none';
}

// ===== Dynamic rows (Edit) =====
function addThirdPartyRowEdit(){
  const wrap = document.getElementById('third_party_rows_edit');
  const div = document.createElement('div');
  div.className = 'col-12 d-flex flex-wrap align-items-end gap-2 third-party-row';
  div.innerHTML = `
    <div style="min-width:260px;" class="flex-grow-1">
      <label class="form-label">Tercero</label>
      <select name="promoter_share_id[]" class="form-select third-party-select">
        <option value="">—</option>
        {% for p in promoters %}<option value="{{ p.id }}">{{ p.nick }}</option>{% endfor %}
      </select>
    </div>
    <div style="width:140px;">
      <label class="form-label">% </label>
      <input type="number" name="promoter_share_pct[]" class="form-control" min="0" max="100">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base %</label>
      <select name="promoter_share_pct_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <div style="width:160px;">
      <label class="form-label">Fijo (€)</label>
      <input type="number" step="0.01" name="promoter_share_amount[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base fijo</label>
      <select name="promoter_share_amount_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.third-party-row').remove()"><i class="fa fa-trash"></i></button>
  `;
  wrap.appendChild(div);
}

function addCompanyRowEdit(){
  const wrap = document.getElementById('company_rows_edit');
  const div = document.createElement('div');
  div.className = 'col-12 d-flex flex-wrap align-items-end gap-2 company-row';
  div.innerHTML = `
    <div style="min-width:260px;" class="flex-grow-1">
      <label class="form-label">Empresa</label>
      <select name="company_share_id[]" class="form-select">
        <option value="">—</option>
        {% for co in companies %}<option value="{{ co.id }}">{{ co.name }}</option>{% endfor %}
      </select>
    </div>
    <div style="width:140px;">
      <label class="form-label">% </label>
      <input type="number" name="company_share_pct[]" class="form-control" min="0" max="100">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base %</label>
      <select name="company_share_pct_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <div style="width:160px;">
      <label class="form-label">Fijo (€)</label>
      <input type="number" step="0.01" name="company_share_amount[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base fijo</label>
      <select name="company_share_amount_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.company-row').remove()"><i class="fa fa-trash"></i></button>
  `;
  wrap.appendChild(div);
}

function addZoneRowEdit(){
  const wrap = document.getElementById('zone_rows_edit');
  const div = document.createElement('div');
  div.className = 'col-12 d-flex flex-wrap align-items-end gap-2 zone-row';
  div.innerHTML = `
    <div style="min-width:260px;" class="flex-grow-1">
      <label class="form-label">Tercero</label>
      <select name="zone_promoter_id[]" class="form-select zone-party-select">
        <option value="">—</option>
        {% for p in promoters %}<option value="{{ p.id }}">{{ p.nick }}</option>{% endfor %}
      </select>
    </div>
    <div style="width:160px;">
      <label class="form-label">% comisión</label>
      <input type="number" step="0.01" name="zone_commission_pct[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base %</label>
      <select name="zone_commission_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <div style="width:160px;">
      <label class="form-label">Fijo (€)</label>
      <input type="number" step="0.01" name="zone_commission_amount[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base fijo</label>
      <select name="zone_commission_amount_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.zone-row').remove()"><i class="fa fa-trash"></i></button>
  `;
  wrap.appendChild(div);
}

function addCacheRowEdit(){
  const wrap = document.getElementById('cache_rows_edit');
  const div = document.createElement('div');
  div.className = 'col-12 d-flex flex-wrap align-items-end gap-2 cache-row';
  div.innerHTML = `
    <div style="width:160px;">
      <label class="form-label">Tipo</label>
      <select name="cache_kind[]" class="form-select" onchange="onCacheKindChange(this)">
        <option value="FIXED">Fijo</option>
        <option value="VARIABLE">Variable</option>
        <option value="OTHER">Otros</option>
      </select>
    </div>
    <div style="width:180px;" data-cache-variable-wrap>
      <label class="form-label">Variable</label>
      <select name="cache_variable_basis[]" class="form-select">
        <option value="">—</option>
        <option value="TICKETS">Por entradas</option>
        <option value="REVENUE">Por recaudación</option>
      </select>
    </div>
    <div style="min-width:220px;" class="flex-grow-1" data-cache-concept-wrap>
      <label class="form-label">Concepto (otros)</label>
      <input name="cache_concept[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">% </label>
      <input type="number" step="0.01" name="cache_pct[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base %</label>
      <select name="cache_pct_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <div style="width:160px;">
      <label class="form-label">Fijo (€)</label>
      <input type="number" step="0.01" name="cache_amount[]" class="form-control">
    </div>
    <div style="width:140px;">
      <label class="form-label">Base fijo</label>
      <select name="cache_amount_base[]" class="form-select">
        <option value="">—</option>
        <option value="GROSS">Bruto</option>
        <option value="NET">Neto</option>
      </select>
    </div>
    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.cache-row').remove()"><i class="fa fa-trash"></i></button>
  `;
  wrap.appendChild(div);
  onCacheKindChange(div.querySelector('select[name="cache_kind[]"]'));
}

function addContractRowEdit(){
  const wrap = document.getElementById('contract_rows_edit');
  const div = document.createElement('div');
  div.className = 'col-12 d-flex flex-wrap align-items-end gap-2 contract-row';
  div.innerHTML = `
    <div style="min-width:260px;" class="flex-grow-1">
      <label class="form-label">Concepto</label>
      <input name="contract_concept[]" class="form-control" placeholder="Ej: Contrato principal">
    </div>
    <div style="width:320px;">
      <label class="form-label">PDF</label>
      <input type="file" name="contract_file[]" accept="application/pdf" class="form-control">
    </div>
    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.contract-row').remove()"><i class="fa fa-trash"></i></button>
  `;
  wrap.appendChild(div);
}

// ====== Modals: Venue / Promoter (reutiliza misma lógica que /conciertos) ======
let __venueTarget = null;
function openVenueModal(target){
  __venueTarget = target || null;
  document.getElementById('venueModalError')?.classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('modalNewVenue'));
  modal.show();
}

async function submitNewVenue(){
  const form = document.getElementById('formNewVenue');
  const err = document.getElementById('venueModalError');
  err?.classList.add('d-none');

  const fd = new FormData(form);
  const r = await fetch('/api/venues/create', { method: 'POST', body: fd });
  const js = await r.json().catch(()=>({}));
  if(!r.ok){
    if(err){ err.textContent = js.error || 'Error creando recinto'; err.classList.remove('d-none'); }
    return;
  }

  if(__venueTarget && __venueTarget.mode === 'typeahead'){
    const input = document.getElementById(__venueTarget.inputId);
    const hidden = document.getElementById(__venueTarget.hiddenId);
    if(input) input.value = js.label || '';
    if(hidden) hidden.value = js.id || '';
  }

  bootstrap.Modal.getInstance(document.getElementById('modalNewVenue'))?.hide();
  form.reset();
}

let __promoterTarget = null;
function openPromoterModal(target){
  __promoterTarget = target || null;
  document.getElementById('promoterModalError')?.classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('modalNewPromoter'));
  modal.show();
}

function addOptionToSelects(selectors, id, label){
  selectors.forEach(sel => {
    document.querySelectorAll(sel).forEach(el => {
      const exists = Array.from(el.options).some(o => o.value === id);
      if(!exists){
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = label;
        el.appendChild(opt);
      }
    });
  });
}

async function submitNewPromoter(){
  const form = document.getElementById('formNewPromoter');
  const err = document.getElementById('promoterModalError');
  err?.classList.add('d-none');

  const fd = new FormData(form);
  const r = await fetch('/api/promoters/create', { method: 'POST', body: fd });
  const js = await r.json().catch(()=>({}));
  if(!r.ok){
    if(err){ err.textContent = js.error || 'Error creando tercero'; err.classList.remove('d-none'); }
    return;
  }

  if(__promoterTarget && __promoterTarget.mode === 'typeahead'){
    const input = document.getElementById(__promoterTarget.inputId);
    const hidden = document.getElementById(__promoterTarget.hiddenId);
    if(input) input.value = js.label || '';
    if(hidden) hidden.value = js.id || '';
  }

  addOptionToSelects(['.third-party-select','.zone-party-select'], js.id, js.label);

  bootstrap.Modal.getInstance(document.getElementById('modalNewPromoter'))?.hide();
  form.reset();
}
</script>

{% endblock %}
