{% extends "layout.html" %}
{% block content %}

<!-- Leaflet (mapa) - lo metemos aquí para no tocar el <head> del layout -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
  .year-grid {
    display: grid;
    grid-template-columns: repeat(1, minmax(0,1fr));
    gap: .75rem;
  }

  @media (min-width: 768px){
    .year-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
  }
  @media (min-width: 1200px){
    .year-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
  }

  .month-card {
    border: 1px solid #eee;
    border-radius: 10px;
    background: #fff;
    overflow: hidden;
  }
  .month-title{
    font-weight: 700;
    padding: .4rem .6rem;
    background: #f8f9fa;
    border-bottom: 1px solid #eee;
  }

  table.month-table{
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 12px;
  }
  table.month-table th{
    text-align: center;
    padding: .25rem 0;
    color: #666;
    font-weight: 700;
    border-bottom: 1px solid #f0f0f0;
  }
  table.month-table td{
    vertical-align: top;
    border-bottom: 1px solid #fafafa;
    border-right: 1px solid #fafafa;
    height: 32px;
    padding: 2px;
    position: relative;
    background: #fff;
  }
  table.month-table tr:last-child td{ border-bottom: 0; }
  table.month-table td:last-child{ border-right: 0; }

  .day-num{
    position: absolute;
    top: 2px;
    left: 4px;
    font-weight: 700;
    font-size: 11px;
    color: #444;
    z-index: 2;
  }
  .day-badges{
    position: absolute;
    bottom: 2px;
    left: 2px;
    right: 2px;
    display: flex;
    gap: 2px;
    flex-wrap: wrap;
    align-items: center;
    z-index: 1;
  }
  .day-badge{
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    font-weight: 900;
    font-size: 13px;
    line-height: 1;
    border: 2px solid #0d6efd; /* se sobreescribe inline por artista */
    box-shadow: 0 1px 4px rgba(0,0,0,.18);
    user-select: none;
  }
  .day-more{
    font-size: 10px;
    color: #666;
    background: #f1f3f5;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 0 4px;
    line-height: 18px;
  }

  /* Colores estado (mismo criterio que en Conciertos) */
  .status-hablado{ background:#ffe8a1; color:#7a5b00; }
  .status-reservado{ background:#cfe2ff; color:#084298; }
  .status-confirmado{ background:#d1e7dd; color:#0f5132; }

  /* Mapa */
  #quad-map{
    height: 520px;
    width: 100%;
  }

  .event-marker .marker-wrap{
    width: 46px;
    height: 46px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    border: 3px solid #0d6efd; /* se sobreescribe inline por artista */
    box-shadow: 0 2px 10px rgba(0,0,0,.25);
  }
  .event-marker .marker-n{
    font-weight: 900;
    font-size: 18px;
    line-height: 1;
  }

  .event-row{
    display: flex;
    gap: .6rem;
    align-items: center;
  }
  .event-n{
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 2px solid #0d6efd; /* se sobreescribe inline por artista */
    display: grid;
    place-items: center;
    font-weight: 800;
    flex: 0 0 auto;
  }
  .summary-table-wrap{
    overflow-x: auto;
  }
  table.summary-table{
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
  }
  table.summary-table th,
  table.summary-table td{
    padding: .35rem .45rem;
    border-bottom: 1px solid #f1f3f5;
    vertical-align: middle;
  }
  table.summary-table th{
    font-size: 11px;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: .02em;
  }
  .artist-group-head{
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 10px;
    padding: .5rem .6rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .75rem;
  }
  .artist-dot{
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: .4rem;
  }
  .mini-pill{
    background: #f8f9fa;
    border: 1px solid #eee;
    border-radius: 999px;
    padding: 0 .45rem;
    font-size: 12px;
    color: #555;
  }
  .promoter-logo{
    width: 28px;
    height: 28px;
    object-fit: contain;
    border-radius: 8px;
    background: #fff;
    border: 1px solid #eee;
    flex: 0 0 auto;
  }


  /* Print/PDF (exportación a PDF con window.print)
     - 2 caras si hay calendario/mapa: 1) resumen 2) calendario+mapa
     - Sin hoja inicial "Cuadrantes" (ocultamos cabecera de pantalla)
  */
  .print-only{ display:none; }
  .print-page{ }
  .print-break-after{ }

  @media print{
    @page { size: A4 landscape; margin: 8mm; }
    nav.navbar { display: none !important; }
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    main.container { max-width: 100% !important; }

    /* IMPORTANTE: permitir que los bloques se partan para evitar páginas en blanco */
    .card { break-inside: auto !important; }

    .print-break-after{ break-after: page; }

    /* Cabecera de impresión con artistas más visible */
    .artist-avatar{ width: 54px !important; height: 54px !important; border-radius: 14px !important; }

    /* Resumen: compactar pero manteniendo 1 línea por evento */
    table.summary-table{ font-size: 10px !important; }
    table.summary-table th{ font-size: 9px !important; }
    table.summary-table th, table.summary-table td{ padding: .18rem .25rem !important; }
    .artist-group-head{ padding: .35rem .45rem !important; }
    .event-n{ width: 28px !important; height: 28px !important; border-radius: 8px !important; }

    /* 2ª cara (CALENDARIO + MAPA EN LA MISMA HOJA)
       - Calendario más pequeño a la izquierda
       - Mapa a la derecha
       - Evitar que ambos se partan entre páginas
    */
    .print-calmap-page{ break-inside: avoid !important; }
    .print-calmap-row{ break-inside: avoid !important; }

    /* En impresión, Bootstrap a veces apila columnas: forzamos layout en fila cuando hay ambos */
    .print-calmap-row.print-both{
      display: flex !important;
      flex-wrap: nowrap !important;
      gap: 6mm !important;
      align-items: stretch !important;
      margin: 0 !important;
    }
    .print-calmap-row.print-both > [class*="col"]{
      padding: 0 !important;
      margin: 0 !important;
      float: none !important;
    }
    .print-calmap-row.print-both .print-col-calendar{
      flex: 0 0 38% !important;
      max-width: 38% !important;
    }
    .print-calmap-row.print-both .print-col-map{
      flex: 1 1 62% !important;
      max-width: 62% !important;
    }

    /* Cards: no partir entre páginas */
    .print-calmap-page .card{ break-inside: avoid !important; }

    /* Cabeceras/paddings más compactos en la 2ª cara */
    .print-calmap-page .card-header{ padding: .25rem .35rem !important; font-size: 10px !important; }
    .print-col-calendar .card-body{ padding: .25rem .35rem !important; }
    .print-col-map .card-body{ padding: 0 !important; overflow: hidden !important; }

    /* Calendario (compacto para que quepa junto al mapa) */
    .print-col-calendar .year-grid{
      gap: 2mm !important;
      grid-template-columns: repeat(3, minmax(0,1fr)) !important;
    }
    .print-col-calendar .month-title{ padding: .12rem .18rem !important; font-size: 8px !important; }
    .print-col-calendar table.month-table{ font-size: 7px !important; }
    .print-col-calendar table.month-table th{ padding: .08rem 0 !important; }
    .print-col-calendar table.month-table td{ height: 14px !important; padding: 1px !important; }
    .print-col-calendar .day-num{ font-size: 8px !important; }
    .print-col-calendar .day-badge{ width: 12px !important; height: 12px !important; font-size: 9px !important; border-width: 2px !important; }
    .print-col-calendar .day-more{ line-height: 12px !important; font-size: 8px !important; }

    /* Mapa: altura fija para garantizar que NO salte a otra hoja */
    .print-col-map #quad-map{ height: 150mm !important; width: 100% !important; }
  }
</style>

<!-- Cabecera de pantalla (NO se imprime para evitar hoja vacía) -->
<div class="d-flex align-items-center justify-content-between mb-3 no-print">
  <div>
    <h3 class="m-0">Cuadrantes</h3>
    <div class="text-muted">Selecciona uno o varios artistas para visualizar calendario + mapa + resumen.</div>
  </div>

  <div class="no-print d-flex gap-2">
    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
      <i class="fa fa-file-pdf"></i> Exportar PDF
    </button>
  </div>
</div>

<form method="get" class="card mb-3 no-print">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-lg-7">
        <label class="form-label mb-1">Artistas</label>
        <select name="artist_id" multiple class="form-select select-artists" data-placeholder="Selecciona artistas...">
          {% for a in artists %}
            <option value="{{ a.id }}" data-photo="{{ a.photo_url or '' }}"
              {% if a.id|string in selected_artist_ids %}selected{% endif %}>
              {{ a.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-lg-2">
        <label class="form-label mb-1">Año</label>
        <select name="year" class="form-select">
          {% for y in year_options %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-6 col-lg-3 d-flex gap-2">
        <button class="btn btn-primary w-100">
          <i class="fa fa-magnifying-glass"></i> Ver cuadrante
        </button>
      </div>
    </div>

    <hr class="my-3">

    <div class="row g-2">
      <div class="col-12">
        <label class="form-label mb-1">Estado</label>
        {% set S = f_statuses or [] %}
        <div class="d-flex flex-wrap gap-2">
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="status" value="HABLADO" {% if 'HABLADO' in S %}checked{% endif %}>
            Hablado
          </label>
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="status" value="RESERVADO" {% if 'RESERVADO' in S %}checked{% endif %}>
            Reservado
          </label>
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="status" value="CONFIRMADO" {% if 'CONFIRMADO' in S %}checked{% endif %}>
            Confirmado
          </label>
        </div>
      </div>

      <div class="col-12 mt-2">
        <label class="form-label mb-1">Tipos</label>
        {% set T = f_sale_types or [] %}
        <div class="d-flex flex-wrap gap-2">
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="type" value="EMPRESA" {% if 'EMPRESA' in T %}checked{% endif %}>
            Empresa
          </label>
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="type" value="GRATUITO" {% if 'GRATUITO' in T %}checked{% endif %}>
            Gratuito
          </label>
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="type" value="PARTICIPADOS" {% if 'PARTICIPADOS' in T %}checked{% endif %}>
            Participado
          </label>
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="type" value="CADIZ" {% if 'CADIZ' in T %}checked{% endif %}>
            Cádiz Music Stadium
          </label>
          <label class="btn btn-outline-secondary btn-sm">
            <input class="form-check-input me-1" type="checkbox" name="type" value="VENDIDO" {% if 'VENDIDO' in T %}checked{% endif %}>
            Vendido
          </label>
        </div>
      </div>
    </div>

    <div class="mt-3">
      <label class="form-label mb-1">Contenido</label>
      <div class="d-flex flex-wrap gap-2">

        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_calendar" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_calendar" value="1" {% if show_calendar %}checked{% endif %}>
          Calendario
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_map" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_map" value="1" {% if show_map %}checked{% endif %}>
          Mapa
        </label>

        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_date" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_date" value="1" {% if show_date %}checked{% endif %}>
          Fecha
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_festival" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_festival" value="1" {% if show_festival %}checked{% endif %}>
          Festival
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_sale_type" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_sale_type" value="1" {% if show_sale_type %}checked{% endif %}>
          Tipo
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_status" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_status" value="1" {% if show_status %}checked{% endif %}>
          Estado
        </label>

        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_province" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_province" value="1" {% if show_province %}checked{% endif %}>
          Provincia
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_municipality" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_municipality" value="1" {% if show_municipality %}checked{% endif %}>
          Municipio
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_venue" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_venue" value="1" {% if show_venue %}checked{% endif %}>
          Recinto
        </label>

        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_capacity" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_capacity" value="1" {% if show_capacity %}checked{% endif %}>
          Aforo
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_cache" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_cache" value="1" {% if show_cache %}checked{% endif %}>
          Caché
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_equipment" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_equipment" value="1" {% if show_equipment %}checked{% endif %}>
          Equipamiento
        </label>
        <label class="btn btn-outline-secondary btn-sm">
          <input type="hidden" name="show_promoter" value="0">
          <input class="form-check-input me-1" type="checkbox" name="show_promoter" value="1" {% if show_promoter %}checked{% endif %}>
          Promotora
        </label>

      </div>
    </div>
  </div>
</form>

<!-- =====================
     RESUMEN (pantalla: debajo del formulario)
     PRINT: 1ª cara
     ===================== -->
<div class="print-page {% if show_calendar or show_map %}print-break-after{% endif %}">
  <div class="card mb-3">
    <div class="card-header">
      <div class="d-flex align-items-start justify-content-between gap-2">
        <div>
          <div class="fw-semibold">Artistas seleccionados</div>
          {% if selected_artists and selected_artists|length > 0 %}
            <div class="d-flex flex-wrap gap-3 mt-2">
              {% for a in selected_artists %}
                <div class="d-flex align-items-center gap-2">
                  <img class="artist-avatar" style="width:36px;height:36px;"
                       src="{{ a.photo_url or url_for('static', filename='img/logo.png') }}"
                       alt="">
                  <div class="fw-semibold">{{ a.name }}</div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted mt-1">No hay artistas seleccionados.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card-body">
      {% if events and events|length > 0 %}
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-semibold">Resumen de eventos ({{ events|length }})</div>
          <div class="text-muted small">Numeración reinicia por artista</div>
        </div>

        {% for g in (events_by_artist or []) %}
          <div class="artist-group-head mb-2">
            <div class="d-flex align-items-center gap-2" style="min-width:0;">
              <span class="artist-dot" style="background: {{ g.artist_color }};"></span>
              <div class="fw-semibold text-truncate">{{ g.artist_name }}</div>
            </div>
            <div class="mini-pill">{{ (g.events or [])|length }}</div>
          </div>

          {% if g.events and (g.events|length) > 0 %}
            <div class="summary-table-wrap mb-3">
              <table class="summary-table">
                <thead>
                  <tr>
                    <th style="width:52px;">#</th>
                    {% if show_date %}<th>Fecha</th>{% endif %}
                    {% if show_festival %}<th>Festival</th>{% endif %}
                    {% if show_sale_type %}<th>Tipo</th>{% endif %}
                    {% if show_province %}<th>Provincia</th>{% endif %}
                    {% if show_municipality %}<th>Municipio</th>{% endif %}
                    {% if show_venue %}<th>Recinto</th>{% endif %}
                    {% if show_capacity %}<th class="text-end">Aforo</th>{% endif %}
                    {% if show_cache %}<th>Caché</th>{% endif %}
                    {% if show_equipment %}<th>Equip.</th>{% endif %}
                    {% if show_status %}<th>Estado</th>{% endif %}
                    {% if show_promoter %}<th>Promotora</th>{% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for e in g.events %}
                    {% set st = (e.status or 'HABLADO') %}
                    {% set st_class = 'status-hablado' if st=='HABLADO' else ('status-reservado' if st=='RESERVADO' else 'status-confirmado') %}
                    <tr>
                      <td>
                        <span class="event-n {{ st_class }}" style="border-color: {{ e.artist_color }};">{{ e.n }}</span>
                      </td>

                      {% if show_date %}<td>{{ e.date_es }}</td>{% endif %}
                      {% if show_festival %}<td>{{ e.festival_name or '' }}</td>{% endif %}
                      {% if show_sale_type %}<td>{{ e.sale_type or '' }}</td>{% endif %}
                      {% if show_province %}<td>{{ e.province or '' }}</td>{% endif %}
                      {% if show_municipality %}<td>{{ e.municipality or '' }}</td>{% endif %}
                      {% if show_venue %}<td>{{ e.venue_name or '' }}</td>{% endif %}
                      {% if show_capacity %}<td class="text-end">{{ e.capacity|k }}</td>{% endif %}
                      {% if show_cache %}<td>{{ e.cache }}</td>{% endif %}
                      {% if show_equipment %}<td>{% if e.has_equipment %}Sí{% else %}—{% endif %}</td>{% endif %}
                      {% if show_status %}<td>{{ st|capitalize }}</td>{% endif %}
                      {% if show_promoter %}
                        <td>
                          {% if e.promoter_logo %}
                            <img class="promoter-logo" src="{{ e.promoter_logo }}" title="{{ e.promoter_name }}" alt="">
                          {% elif e.promoter_name %}
                            {{ e.promoter_name }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-muted mb-3">Sin eventos con los filtros actuales.</div>
          {% endif %}
        {% endfor %}

      {% else %}
        <div class="text-muted">
          Selecciona uno o varios artistas y pulsa <b>Ver cuadrante</b>.
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =====================
     CALENDARIO + MAPA
     Pantalla: debajo del resumen, 50/50
     PRINT: 2ª cara
     ===================== -->
{% if show_calendar or show_map %}
  <div class="print-page print-calmap-page">
    <div class="row g-3 print-calmap-row {% if show_calendar and show_map %}print-both{% else %}print-single{% endif %}">
      {% if show_calendar %}
      <div class="col-12 col-lg-6 print-col-calendar">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span class="fw-semibold"><i class="fa fa-calendar"></i> Calendario {{ year }}</span>
            <span class="text-muted small">Días con evento muestran el número</span>
          </div>
          <div class="card-body">
            <div class="year-grid">
              {% for m in months %}
                <div class="month-card">
                  <div class="month-title">{{ m.name }}</div>
                  <table class="month-table">
                    <thead>
                      <tr>
                        {% for d in dow %}
                          <th>{{ d }}</th>
                        {% endfor %}
                      </tr>
                    </thead>
                    <tbody>
                      {% for week in m.weeks %}
                        <tr>
                          {% for day in week %}
                            {% if day == 0 %}
                              <td></td>
                            {% else %}
                              {% set date_str = "%04d-%02d-%02d"|format(year, m.num, day) %}
                              {% set marks = marks_by_date.get(date_str, []) %}
                              <td>
                                <div class="day-num">{{ day }}</div>
                                {% if marks and marks|length > 0 %}
                                  <div class="day-badges">
                                    {% for it in marks[:4] %}
                                      {% set st = (it.status or 'HABLADO') %}
                                      {% set st_class = 'status-hablado' if st=='HABLADO' else ('status-reservado' if st=='RESERVADO' else 'status-confirmado') %}
                                      <span class="day-badge {{ st_class }}" style="border-color: {{ it.artist_color or '#0d6efd' }};" title="{{ it.title or it.artist_name or '' }}">{{ it.n }}</span>
                                    {% endfor %}
                                    {% if marks|length > 4 %}
                                      <span class="day-more">+{{ marks|length - 4 }}</span>
                                    {% endif %}
                                  </div>
                                {% endif %}
                              </td>
                            {% endif %}
                          {% endfor %}
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      {% if show_map %}
      <div class="col-12 col-lg-6 print-col-map">
        <div class="card h-100">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span class="fw-semibold"><i class="fa fa-map"></i> Mapa</span>
            <span class="text-muted small">Chinchetas = número del evento</span>
          </div>
          <div class="card-body p-0">
            <div id="quad-map"></div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
{% endif %}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Metemos el JSON aquí para que el editor no lo trate como JS -->
<script id="quad-events-json" type="application/json">
  {{ (events or []) | tojson }}
</script>

<script>
  const EVENTS = JSON.parse(
    document.getElementById("quad-events-json")?.textContent || "[]"
  );

  // Ajuste para impresión: Leaflet necesita recalcular tamaños cuando cambia el layout (CSS de print).
  window.addEventListener("beforeprint", () => {
    try {
      if (window.__quadMap){
        setTimeout(() => { try { window.__quadMap.invalidateSize(true); } catch(e){} }, 250);
      }
    } catch(e){}
  });
  window.addEventListener("afterprint", () => {
    try {
      if (window.__quadMap){
        setTimeout(() => { try { window.__quadMap.invalidateSize(true); } catch(e){} }, 250);
      }
    } catch(e){}
  });

  function getGeoCache(){
    try { return JSON.parse(localStorage.getItem("quad_geo_cache") || "{}"); }
    catch(e){ return {}; }
  }
  
  function setGeoCache(obj){
    try { localStorage.setItem("quad_geo_cache", JSON.stringify(obj)); }
    catch(e){}
  }

  async function geocodeCity(city, province){
    const key = (city || "") + "|" + (province || "");
    const cache = getGeoCache();
    if (cache[key]) return cache[key];

    const url = `/api/geocode?city=${encodeURIComponent(city||"")}&province=${encodeURIComponent(province||"")}`;
    const r = await fetch(url);
    if (!r.ok) return null;
    const js = await r.json();
    if (!js.ok) return null;

    cache[key] = {lat: js.lat, lng: js.lng};
    setGeoCache(cache);
    return cache[key];
  }

  function statusToClass(st){
    const s = (st || "").toUpperCase();
    if (s === "RESERVADO") return "status-reservado";
    if (s === "CONFIRMADO") return "status-confirmado";
    return "status-hablado";
  }

  function eventIcon(n, status, artistColor){
    const cls = statusToClass(status);
    const border = artistColor || "#0d6efd";
    const nn = (n === 0 || n) ? String(n) : "?";
    return L.divIcon({
      className: "event-marker",
      html: `<div class="marker-wrap ${cls}" style="border-color:${border}"><div class="marker-n">${nn}</div></div>`,
      iconSize: [46, 46],
      iconAnchor: [23, 23]
    });
  }

  (async function initMap(){
    const el = document.getElementById("quad-map");
    if (!el) return;

    const map = L.map("quad-map", {scrollWheelZoom: false}).setView([40.4168, -3.7038], 6);
    window.__quadMap = map;
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: "&copy; OpenStreetMap"
    }).addTo(map);

    // Al cambiar el layout (resumen arriba + mapa abajo) Leaflet a veces necesita recalcular tamaños.
    // Esto evita que salga "encogido" o con tiles mal colocadas.
    setTimeout(() => {
      try { map.invalidateSize(); } catch(e) {}
    }, 250);

    const bounds = [];

    for (const e of EVENTS){
      const city = e.municipality || "";
      const prov = e.province || "";
      if (!city) continue;

      const coords = await geocodeCity(city, prov);
      if (!coords) continue;

      const m = L.marker([coords.lat, coords.lng], {icon: eventIcon(e.n, e.status, e.artist_color)}).addTo(map);

      const html = `
        <div style="min-width:220px">
          <div><b>${(e.artist_name || "")} · Evento ${e.n}</b></div>
          <div>${e.date_es || ""}</div>
          <div>${(e.venue_name||"")} — ${city}${prov ? ", " + prov : ""}</div>
        </div>
      `;
      m.bindPopup(html);

      bounds.push([coords.lat, coords.lng]);
    }

    if (bounds.length){
      map.fitBounds(bounds, {padding: [20, 20]});
    }
  })();
</script>

{% endblock %}
