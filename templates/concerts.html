{% extends "layout.html" %}
{% block content %}
<h4 class="mb-3">Conciertos</h4>

<!-- ALTA -->
<div class="card mb-4">
  <div class="card-body">
    <form method="post" class="row g-2">
      <div class="col-md-2">
        <label class="form-label">Fecha</label>
        <input type="date" name="date" class="form-control" required>
      </div>
      <div class="col-md-3">
        <label class="form-label">Artista</label>
        <select name="artist_id" class="form-select" required>
          {% for a in artists %}<option value="{{ a.id }}">{{ a.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Nombre (festival, opcional)</label>
        <input name="festival_name" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Recinto</label>
        <select name="venue_id" class="form-select" required>
          {% for v in venues %}<option value="{{ v.id }}">{{ v.name }} — {{ v.municipality or '' }} {{ v.province or '' }}</option>{% endfor %}
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Tipo</label>
        <select name="sale_type" class="form-select" id="sale_type_select">
          <option value="EMPRESA">Empresa</option>
          <option value="VENDIDO">Vendido</option>
          <option value="PARTICIPADOS">Participados</option>
          <option value="CADIZ">CADIZ MUSIC STADIUM</option>
        </select>
      </div>

      <div class="col-md-3" id="company_single_wrap">
        <label class="form-label">Empresa del grupo</label>
        <select name="group_company_id" class="form-select">
          <option value="">—</option>
          {% for co in companies %}<option value="{{ co.id }}">{{ co.name }}</option>{% endfor %}
        </select>
      </div>

      <div class="col-md-3" id="promoter_single_wrap" style="display:none;">
        <label class="form-label">Tercero</label>
        <select name="promoter_id" class="form-select">
          <option value="">—</option>
          {% for p in promoters %}<option value="{{ p.id }}">{{ p.nick }}</option>{% endfor %}
        </select>
      </div>

      <div class="col-12" id="shares_wrap" style="display:none;">
        <div class="border rounded p-2 mb-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Participación de terceros</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addShareRow('promoter','create')"><i class="fa fa-plus"></i> Añadir</button>
          </div>
          <div id="promoter_shares_rows_create" class="row g-2"></div>
        </div>
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Participación de empresas del grupo</strong>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addShareRow('company','create')"><i class="fa fa-plus"></i> Añadir</button>
          </div>
          <div id="company_shares_rows_create" class="row g-2"></div>
        </div>
      </div>

      <div class="col-md-2">
        <label class="form-label">Aforo</label>
        <input type="number" name="capacity" class="form-control" required min="0">
      </div>
      <div class="col-md-2">
        <label class="form-label">Inicio venta</label>
        <input type="date" name="sale_start_date" class="form-control" required>
      </div>
      <div class="col-md-2">
        <label class="form-label">Punto de empate <small class="text-muted">(opcional)</small></label>
        <input type="number" name="break_even_ticket" class="form-control" min="0">
      </div>

      <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-primary">Crear</button>
      </div>
    </form>
  </div>
</div>

<!-- LISTADO / EDICIÓN BÁSICA -->
<div class="row">
  {% for c in concerts %}
  <div class="col-lg-6">
    <div class="card mb-3">
      <div class="card-body">
        <form id="form-edit-{{ c.id }}" method="post" action="{{ url_for('concert_update', cid=c.id) }}" class="row g-2">
          <div class="col-md-2"><label class="form-label">Fecha</label><input type="date" name="date" class="form-control" value="{{ c.date.isoformat() }}"></div>
          <div class="col-md-3"><label class="form-label">Artista</label>
            <select name="artist_id" class="form-select">
              {% for a in artists %}<option value="{{ a.id }}" {% if a.id==c.artist_id %}selected{% endif %}>{{ a.name }}</option>{% endfor %}
            </select>
          </div>
          <div class="col-md-3"><label class="form-label">Nombre (festival)</label><input name="festival_name" class="form-control" value="{{ c.festival_name or '' }}"></div>
          <div class="col-md-4"><label class="form-label">Recinto</label>
            <select name="venue_id" class="form-select">
              {% for v in venues %}<option value="{{ v.id }}" {% if v.id==c.venue_id %}selected{% endif %}>{{ v.name }} — {{ v.municipality or '' }} {{ v.province or '' }}</option>{% endfor %}
            </select>
          </div>

          <div class="col-md-3"><label class="form-label">Tipo</label>
            <select name="sale_type" class="form-select sale-type-edit" data-edit-id="{{ c.id }}">
              <option value="EMPRESA" {% if c.sale_type=='EMPRESA' %}selected{% endif %}>Empresa</option>
              <option value="VENDIDO" {% if c.sale_type=='VENDIDO' %}selected{% endif %}>Vendido</option>
              <option value="PARTICIPADOS" {% if c.sale_type=='PARTICIPADOS' %}selected{% endif %}>Participados</option>
              <option value="CADIZ" {% if c.sale_type=='CADIZ' %}selected{% endif %}>CADIZ MUSIC STADIUM</option>
            </select>
          </div>

          <div class="col-md-3 company-single-edit" id="company_single_wrap_{{ c.id }}" {% if c.sale_type != 'EMPRESA' %}style="display:none"{% endif %}>
            <label class="form-label">Empresa</label>
            <select name="group_company_id" class="form-select">
              <option value="">—</option>
              {% for co in companies %}<option value="{{ co.id }}" {% if c.group_company_id and co.id==c.group_company_id %}selected{% endif %}>{{ co.name }}</option>{% endfor %}
            </select>
          </div>

          <div class="col-md-3 promoter-single-edit" id="promoter_single_wrap_{{ c.id }}" {% if c.sale_type != 'VENDIDO' %}style="display:none"{% endif %}>
            <label class="form-label">Tercero</label>
            <select name="promoter_id" class="form-select">
              <option value="">—</option>
              {% for p in promoters %}<option value="{{ p.id }}" {% if c.promoter_id and p.id==c.promoter_id %}selected{% endif %}>{{ p.nick }}</option>{% endfor %}
            </select>
          </div>

          <div class="col-12 shares-edit" id="shares_wrap_{{ c.id }}" {% if c.sale_type not in ['PARTICIPADOS','CADIZ'] %}style="display:none"{% endif %}>
            <div class="border rounded p-2 mb-2">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Participación de terceros</strong>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addShareRow('promoter','edit', '{{ c.id }}')"><i class="fa fa-plus"></i> Añadir</button>
              </div>
              <div id="promoter_shares_rows_edit_{{ c.id }}" class="row g-2">
                {% for s in c.promoter_shares %}
                  <div class="col-md-6 d-flex align-items-end gap-2">
                    <div class="flex-grow-1">
                      <label class="form-label">Tercero</label>
                      <select name="promoter_id_share[]" class="form-select">
                        <option value="">—</option>
                        {% for p in promoters %}<option value="{{ p.id }}" {% if p.id==s.promoter_id %}selected{% endif %}>{{ p.nick }}</option>{% endfor %}
                      </select>
                    </div>
                    <div style="width:120px;">
                      <label class="form-label">% </label>
                      <input type="number" name="promoter_pct[]" class="form-control" min="0" max="100" value="{{ s.pct }}">
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="fa fa-trash"></i></button>
                  </div>
                {% endfor %}
              </div>
            </div>

            <div class="border rounded p-2">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Participación de empresas</strong>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addShareRow('company','edit', '{{ c.id }}')"><i class="fa fa-plus"></i> Añadir</button>
              </div>
              <div id="company_shares_rows_edit_{{ c.id }}" class="row g-2">
                {% for s in c.company_shares %}
                  <div class="col-md-6 d-flex align-items-end gap-2">
                    <div class="flex-grow-1">
                      <label class="form-label">Empresa</label>
                      <select name="company_id_share[]" class="form-select">
                        <option value="">—</option>
                        {% for co in companies %}<option value="{{ co.id }}" {% if co.id==s.company_id %}selected{% endif %}>{{ co.name }}</option>{% endfor %}
                      </select>
                    </div>
                    <div style="width:120px;">
                      <label class="form-label">% </label>
                      <input type="number" name="company_pct[]" class="form-control" min="0" max="100" value="{{ s.pct }}">
                    </div>
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="fa fa-trash"></i></button>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div class="col-md-2"><label class="form-label">Aforo</label><input type="number" name="capacity" class="form-control" value="{{ c.capacity }}"></div>
          <div class="col-md-2"><label class="form-label">Inicio venta</label><input type="date" name="sale_start_date" class="form-control" value="{{ c.sale_start_date.isoformat() }}"></div>
          <div class="col-md-2"><label class="form-label">Empate</label><input type="number" name="break_even_ticket" class="form-control" value="{{ c.break_even_ticket if c.break_even_ticket is not none else '' }}"></div>
          <div class="d-flex gap-2 justify-content-end mt-2">
            <button form="form-edit-{{ c.id }}" class="btn btn-outline-primary">Guardar</button>
            <form method="post"
                  action="{{ url_for('concert_delete', cid=c.id) }}"
                  onsubmit="return confirm('¿Seguro que quieres borrar este concierto?');">
              <button class="btn btn-outline-danger"><i class="fa fa-trash"></i> Borrar</button>
            </form>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<script>
function refreshTypeUI() {
  const v = document.getElementById('sale_type_select').value;
  document.getElementById('company_single_wrap').style.display = (v === 'EMPRESA') ? '' : 'none';
  document.getElementById('promoter_single_wrap').style.display = (v === 'VENDIDO') ? '' : 'none';
  document.getElementById('shares_wrap').style.display = (v === 'PARTICIPADOS' || v === 'CADIZ') ? '' : 'none';
}
document.getElementById('sale_type_select').addEventListener('change', refreshTypeUI);
refreshTypeUI();

// Añadir filas a create/edit
function addShareRow(kind, mode, editId) {
  const wrapId = (mode === 'edit')
      ? (kind === 'promoter' ? `promoter_shares_rows_edit_${editId}` : `company_shares_rows_edit_${editId}`)
      : (kind === 'promoter' ? 'promoter_shares_rows_create' : 'company_shares_rows_create');

  const wrap = document.getElementById(wrapId);
  const div = document.createElement('div');
  div.className = 'col-md-6 d-flex align-items-end gap-2';

  if (kind === 'promoter') {
    div.innerHTML = `
      <div class="flex-grow-1">
        <label class="form-label">Tercero</label>
        <select name="promoter_id_share[]" class="form-select">
          <option value="">—</option>
          {% for p in promoters %}<option value="{{ p.id }}">{{ p.nick }}</option>{% endfor %}
        </select>
      </div>
      <div style="width:120px;">
        <label class="form-label">% </label>
        <input type="number" name="promoter_pct[]" class="form-control" min="0" max="100" value="0">
      </div>
      <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="fa fa-trash"></i></button>
    `;
  } else {
    div.innerHTML = `
      <div class="flex-grow-1">
        <label class="form-label">Empresa</label>
        <select name="company_id_share[]" class="form-select">
          <option value="">—</option>
          {% for co in companies %}<option value="{{ co.id }}">{{ co.name }}</option>{% endfor %}
        </select>
      </div>
      <div style="width:120px;">
        <label class="form-label">% </label>
        <input type="number" name="company_pct[]" class="form-control" min="0" max="100" value="0">
      </div>
      <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()"><i class="fa fa-trash"></i></button>
    `;
  }
  wrap.appendChild(div);
}

// Mostrar/ocultar en edición cuando cambias el tipo
document.querySelectorAll('.sale-type-edit').forEach(sel => {
  sel.addEventListener('change', (e) => {
    const id = e.target.getAttribute('data-edit-id');
    const v = e.target.value;
    document.getElementById(`company_single_wrap_${id}`).style.display = (v === 'EMPRESA') ? '' : 'none';
    document.getElementById(`promoter_single_wrap_${id}`).style.display = (v === 'VENDIDO') ? '' : 'none';
    document.getElementById(`shares_wrap_${id}`).style.display = (v === 'PARTICIPADOS' || v === 'CADIZ') ? '' : 'none';
  });
});
</script>
{% endblock %}