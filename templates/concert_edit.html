{% extends "layout.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Editar concierto</h4>
    <div class="text-muted small">{{ concert.artist.name if concert.artist else '—' }} · {{ concert.date.strftime('%d/%m/%Y') if concert.date else '—' }}</div>
  </div>
  <a href="{{ url_for('concerts_view', tab='vista') }}#concert-{{ concert.id }}" class="btn btn-outline-secondary">
    <i class="fa fa-arrow-left"></i> Volver
  </a>
</div>

<form method="post" enctype="multipart/form-data" class="row g-2">

  <!-- fila 1: Estado -->
  <div class="col-12">
    <label class="form-label">Estado</label>
    <select name="status" class="form-select" required>
      <option value="HABLADO" {% if concert.status=='HABLADO' %}selected{% endif %}>Hablado</option>
      <option value="RESERVADO" {% if concert.status=='RESERVADO' %}selected{% endif %}>Reservado</option>
      <option value="CONFIRMADO" {% if concert.status=='CONFIRMADO' %}selected{% endif %}>Confirmado</option>
    </select>
  </div>

  <!-- fila 2: Artista / Fecha / Nombre -->
  <div class="col-md-5">
    <label class="form-label">Artista</label>
    <select name="artist_id" class="form-select select-artists" required>
      {% for a in artists %}
        <option value="{{ a.id }}" data-photo="{{ a.photo_url or url_for('static', filename='img/logo.png') }}" {% if concert.artist_id == a.id %}selected{% endif %}>{{ a.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Fecha</label>
    <input type="date" name="date" class="form-control" required value="{{ concert.date.isoformat() if concert.date else '' }}">
  </div>
  <div class="col-md-5">
    <label class="form-label">Nombre del festival / evento <small class="text-muted">(opcional)</small></label>
    <input name="festival_name" class="form-control" value="{{ concert.festival_name or '' }}" placeholder="Festival / nombre interno">
  </div>

  <!-- fila 3: Recinto / Aforo / Salida / Empresa factura -->
  <div class="col-md-5">
    <label class="form-label">Recinto</label>
    <select name="venue_id" class="form-select" required>
      {% for v in venues %}
        <option value="{{ v.id }}" {% if concert.venue_id == v.id %}selected{% endif %}>{{ v.name }} — {{ v.municipality }} ({{ v.province }})</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <label class="form-label">Aforo a la venta</label>
    <input type="number" name="capacity" class="form-control" required min="0" value="{{ concert.capacity or 0 }}">
  </div>
  <div class="col-md-2">
    <label class="form-label">Salida a la venta</label>
    <input type="date" name="sale_start_date" class="form-control" required value="{{ concert.sale_start_date.isoformat() if concert.sale_start_date else '' }}">
  </div>
  <div class="col-md-3">
    <label class="form-label">Empresa que factura</label>
    <select name="billing_company_id" class="form-select" required>
      <option value="">—</option>
      {% for co in companies %}
        <option value="{{ co.id }}" {% if concert.billing_company_id == co.id %}selected{% endif %}>{{ co.name }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- fila 4: Tipo / Empresa gestiona o Promotor / Punto empate -->
  <div class="col-md-4">
    <label class="form-label">Tipo de concierto</label>
    <select name="sale_type" class="form-select" id="sale_type_select">
      <option value="EMPRESA" {% if concert.sale_type=='EMPRESA' %}selected{% endif %}>Empresa</option>
      <option value="VENDIDO" {% if concert.sale_type=='VENDIDO' %}selected{% endif %}>Vendido</option>
      <option value="PARTICIPADOS" {% if concert.sale_type=='PARTICIPADOS' %}selected{% endif %}>Participado</option>
      <option value="CADIZ" {% if concert.sale_type=='CADIZ' %}selected{% endif %}>Cádiz Music Stadium</option>
    </select>
  </div>

  <div class="col-md-4" id="company_single_wrap">
    <label class="form-label">Empresa del grupo que lo gestiona</label>
    <select name="group_company_id" class="form-select">
      <option value="">—</option>
      {% for co in companies %}
        <option value="{{ co.id }}" {% if concert.group_company_id == co.id %}selected{% endif %}>{{ co.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4" id="promoter_single_wrap">
    <label class="form-label">Promotor</label>
    <div class="input-group">
      <select name="promoter_id" class="form-select third-party-select">
        <option value="">—</option>
        {% for p in promoters %}
          <option value="{{ p.id }}" data-logo="{{ p.logo_url or url_for('static', filename='img/promoter_default.png') }}" {% if concert.promoter_id == p.id %}selected{% endif %}>{{ p.nick }}</option>
        {% endfor %}
      </select>
      <button type="button" class="btn btn-outline-secondary" onclick="openPromoterModal({mode:'select2', selectName:'promoter_id'})"><i class="fa fa-plus"></i></button>
    </div>
  </div>

  <div class="col-md-4" id="break_even_wrap">
    <label class="form-label">Punto de empate <small class="text-muted">(opcional)</small></label>
    <input type="number" name="break_even_ticket" class="form-control" min="0" value="{{ concert.break_even_ticket or '' }}" placeholder="Vacío = sin punto">
  </div>

  <!-- ==================== COLABORADORES (no vendido) ==================== -->
  <div class="col-12 mt-3" id="collab_block">
    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Colaboradores <span class="text-muted fw-normal">(opcionales)</span></strong>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleBlock('block-collab')">
          <i class="fa fa-chevron-down"></i>
        </button>
      </div>

      <div id="block-collab" style="display:none;">

        <!-- empresas -->
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Participaciones de empresas</div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCompanyShareRow('company_shares_container')">+ Añadir</button>
          </div>
          <div id="company_shares_container" class="mt-2">
            {% for s in concert.company_shares %}
              <div class="row g-2 align-items-end mb-2">
                <div class="col-md-5">
                  <label class="form-label">Empresa</label>
                  <select name="company_share_id[]" class="form-select">
                    <option value="">—</option>
                    {% for co in companies %}
                      <option value="{{ co.id }}" {% if s.company_id == co.id %}selected{% endif %}>{{ co.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">% (opcional)</label>
                  <input type="number" step="0.01" name="company_share_pct[]" class="form-control" value="{{ s.pct or '' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Base %</label>
                  <select name="company_share_pct_base[]" class="form-select">
                    <option value="GROSS" {% if s.pct_base=='GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if s.pct_base=='NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>
                <div class="col-md-1 d-grid">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()"><i class="fa fa-trash"></i></button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <!-- promotores / terceros -->
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Promotores / terceros</div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPromoterShareRow('promoter_shares_container')">+ Añadir</button>
          </div>
          <div id="promoter_shares_container" class="mt-2">
            {% for s in concert.promoter_shares %}
              <div class="row g-2 align-items-end mb-2">
                <div class="col-md-5">
                  <label class="form-label">Promotor</label>
                  <div class="input-group">
                    <select name="promoter_share_id[]" class="form-select third-party-select">
                      <option value="">—</option>
                      {% for p in promoters %}
                        <option value="{{ p.id }}" data-logo="{{ p.logo_url or url_for('static', filename='img/promoter_default.png') }}" {% if s.promoter_id == p.id %}selected{% endif %}>{{ p.nick }}</option>
                      {% endfor %}
                    </select>
                    <button type="button" class="btn btn-outline-secondary" onclick="openPromoterModal({mode:'select2', selectName:'promoter_share_id[]'})"><i class="fa fa-plus"></i></button>
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">% (opcional)</label>
                  <input type="number" step="0.01" name="promoter_share_pct[]" class="form-control" value="{{ s.pct or '' }}">
                </div>
                <div class="col-md-2">
                  <label class="form-label">Base %</label>
                  <select name="promoter_share_pct_base[]" class="form-select">
                    <option value="GROSS" {% if s.pct_base=='GROSS' %}selected{% endif %}>Bruto</option>
                    <option value="NET" {% if s.pct_base=='NET' %}selected{% endif %}>Neto</option>
                  </select>
                </div>
                <div class="col-md-1 d-grid">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()"><i class="fa fa-trash"></i></button>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ==================== CACHES ==================== -->
  <div class="col-12">
    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Cachés <span class="text-muted fw-normal">(opcionales)</span></strong>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCacheRow('caches_container')">+ Añadir</button>
      </div>

      <div id="caches_container">
        {% for ch in concert.caches %}
          {% set cfg = ch.config or {} %}
          <div class="border rounded p-2 mb-2 cache-row">
            <div class="row g-2 align-items-end">
              <div class="col-md-3">
                <label class="form-label">Tipo</label>
                <select name="cache_kind[]" class="form-select cache-kind" onchange="onCacheKindChange(this)">
                  <option value="FIXED" {% if ch.kind=='FIXED' %}selected{% endif %}>Fijo</option>
                  <option value="VARIABLE" {% if ch.kind=='VARIABLE' %}selected{% endif %}>Variable</option>
                  <option value="OTHER" {% if ch.kind=='OTHER' %}selected{% endif %}>Otros</option>
                </select>
              </div>

              <div class="col-md-4 cache-fixed-wrap" {% if ch.kind!='FIXED' %}style="display:none"{% endif %}>
                <label class="form-label">Importe (€)</label>
                <input type="number" step="0.01" name="cache_amount[]" class="form-control" value="{{ ch.amount or '' }}">
              </div>

              <div class="col-md-4 cache-other-wrap" {% if ch.kind!='OTHER' %}style="display:none"{% endif %}>
                <label class="form-label">Concepto</label>
                <input name="cache_concept[]" class="form-control" value="{{ ch.concept or '' }}" placeholder="Concepto">
              </div>

              <div class="col-md-4 cache-variable-wrap" {% if ch.kind!='VARIABLE' %}style="display:none"{% endif %}>
                <label class="form-label">Modo</label>
                <select name="cache_var_mode[]" class="form-select cache-var-mode" onchange="onCacheVarModeChange(this)">
                  <option value="FIXED" {% if cfg.get('mode')=='FIXED' %}selected{% endif %}>Fijo</option>
                  <option value="PERCENT" {% if cfg.get('mode')=='PERCENT' %}selected{% endif %}>Porcentaje</option>
                </select>
              </div>

              <div class="col-md-4 cache-variable-wrap" {% if ch.kind!='VARIABLE' %}style="display:none"{% endif %}>
                <label class="form-label">Opción</label>
                <select name="cache_var_option[]" class="form-select cache-var-option" onchange="onCacheVarOptionChange(this)"></select>
              </div>

              <div class="col-md-3 cache-variable-wrap" {% if ch.kind!='VARIABLE' %}style="display:none"{% endif %}>
                <label class="form-label">Valor</label>
                <input type="number" step="0.01" name="cache_var_value[]" class="form-control" value="{{ (ch.amount if cfg.get('mode')=='FIXED' else ch.pct) or '' }}" placeholder="Importe o %">
                <input type="hidden" name="cache_pct[]" value="{{ ch.pct or '' }}">
              </div>

              <div class="col-md-2 cache-var-base-wrap" {% if not (ch.kind=='VARIABLE' and cfg.get('mode')=='PERCENT') %}style="display:none"{% endif %}>
                <label class="form-label">Base %</label>
                <select name="cache_pct_base[]" class="form-select">
                  <option value="GROSS" {% if ch.pct_base=='GROSS' %}selected{% endif %}>Bruto</option>
                  <option value="NET" {% if ch.pct_base=='NET' %}selected{% endif %}>Neto</option>
                </select>
              </div>

              <!-- thresholds / extra -->
              <input type="hidden" name="cache_from_ticket[]" value="{{ cfg.get('from_ticket','') }}">
              <input type="hidden" name="cache_min_tickets[]" value="{{ cfg.get('min_tickets','') }}">
              <input type="hidden" name="cache_min_revenue[]" value="{{ cfg.get('min_revenue','') }}">
              <input type="hidden" name="cache_ticket_type[]" value="{{ cfg.get('ticket_type','') }}">

              <div class="col-md-1 d-grid">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.cache-row').remove()"><i class="fa fa-trash"></i></button>
              </div>
            </div>

            <!-- extra inputs area (JS la rellena) -->
            <div class="cache-extra mt-2"></div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ==================== COMISIONISTAS ==================== -->
  <div class="col-12" id="zone_block">
    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Comisionistas <span class="text-muted fw-normal">(opcionales)</span></strong>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addZoneRow('zone_container')">+ Añadir</button>
      </div>

      <div id="zone_container">
        {% for z in concert.zone_agents %}
          <div class="border rounded p-2 mb-2 zone-row">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Comisionista</label>
                <div class="input-group">
                  <select name="zone_promoter_id[]" class="form-select third-party-select">
                    <option value="">—</option>
                    {% for p in promoters %}
                      <option value="{{ p.id }}" data-logo="{{ p.logo_url or url_for('static', filename='img/promoter_default.png') }}" {% if z.promoter_id == p.id %}selected{% endif %}>{{ p.nick }}</option>
                    {% endfor %}
                  </select>
                  <button type="button" class="btn btn-outline-secondary" onclick="openPromoterModal({mode:'select2', selectName:'zone_promoter_id[]'})"><i class="fa fa-plus"></i></button>
                </div>
              </div>

              <div class="col-md-2">
                <label class="form-label">Tipo</label>
                <select name="zone_commission_mode[]" class="form-select" onchange="onZoneModeChange(this)">
                  <option value="FIXED" {% if z.commission_type != 'PERCENT' %}selected{% endif %}>Fijo</option>
                  <option value="PERCENT" {% if z.commission_type == 'PERCENT' %}selected{% endif %}>% (variable)</option>
                </select>
              </div>

              <div class="col-md-2 zone-pct-wrap" {% if z.commission_type != 'PERCENT' %}style="display:none"{% endif %}>
                <label class="form-label">%</label>
                <input type="number" step="0.01" name="zone_commission_pct[]" class="form-control" value="{{ z.commission_pct or '' }}">
              </div>
              <div class="col-md-2 zone-pct-wrap" {% if z.commission_type != 'PERCENT' %}style="display:none"{% endif %}>
                <label class="form-label">Base</label>
                <select name="zone_commission_base[]" class="form-select">
                  <option value="GROSS" {% if z.commission_base=='GROSS' %}selected{% endif %}>Bruto</option>
                  <option value="NET" {% if z.commission_base=='NET' %}selected{% endif %}>Neto</option>
                </select>
              </div>

              <div class="col-md-4 zone-amt-wrap" {% if z.commission_type == 'PERCENT' %}style="display:none"{% endif %}>
                <label class="form-label">Importe fijo (€)</label>
                <input type="number" step="0.01" name="zone_commission_amount[]" class="form-control" value="{{ z.commission_amount or '' }}">
              </div>

              <div class="col-md-2">
                <label class="form-label">Importe exento <small class="text-muted">(opcional)</small></label>
                <input type="number" step="0.01" name="zone_exempt_amount[]" class="form-control" value="{{ z.exempt_amount or '' }}">
              </div>

              <div class="col-md-1 d-grid">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-outline-danger" onclick="this.closest('.zone-row').remove()"><i class="fa fa-trash"></i></button>
              </div>

              <div class="col-12">
                <label class="form-label">Motivo / Concepto</label>
                <textarea name="zone_concept[]" class="form-control" rows="2" placeholder="Motivo de la comisión...">{{ z.concept or '' }}</textarea>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- ==================== EQUIPAMIENTO ==================== -->
  <div class="col-12">
    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Equipamiento <span class="text-muted fw-normal">(opcional)</span></strong>
      </div>

      {% set eq = concert.equipment %}

      <div class="row g-2">
        <div class="col-md-8">
          <label class="form-label">Equipos incluidos</label>
          <select name="equipment_included[]" class="form-select" multiple size="6">
            {% set selected_eq = (eq.included if eq and eq.included else []) %}
            {% for opt in ['Sonido','Iluminación','Pantallas','Backline','Escenario','Generadores','Vallas','Camerinos','Seguridad','Producción'] %}
              <option value="{{ opt }}" {% if opt in selected_eq %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
          <div class="form-text">Puedes seleccionar varios.</div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Otros <small class="text-muted">(opcional)</small></label>
          <input name="equipment_other" class="form-control" value="{{ eq.other if eq else '' }}" placeholder="Texto libre">

          <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" id="equipment_covered" name="equipment_covered" {% if eq and eq.covered_by_promoter %}checked{% endif %} onchange="toggleEquipmentCovered()">
            <label class="form-check-label" for="equipment_covered">Cubierto por promotor</label>
          </div>

          <div id="equipment_covered_wrap" class="mt-2" {% if not (eq and eq.covered_by_promoter) %}style="display:none"{% endif %}>
            <label class="form-label">Tipo</label>
            <select name="equipment_covered_mode" class="form-select" id="equipment_covered_mode" onchange="toggleEquipmentCoveredMode()">
              <option value="RIDER" {% if eq and eq.covered_mode=='RIDER' %}selected{% endif %}>Rider de artista</option>
              <option value="AMOUNT" {% if eq and eq.covered_mode=='AMOUNT' %}selected{% endif %}>Importe concreto</option>
            </select>

            <div id="equipment_covered_amount_wrap" class="mt-2" {% if not (eq and eq.covered_mode=='AMOUNT') %}style="display:none"{% endif %}>
              <label class="form-label">Importe (€)</label>
              <input type="number" step="0.01" name="equipment_covered_amount" class="form-control" value="{{ eq.covered_amount if eq else '' }}">
            </div>
          </div>
        </div>
      </div>

      <hr class="my-3">

      <!-- riders -->
      <div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Riders / PDFs</div>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEquipmentDocRow('equipment_docs_container')">+ Adjuntar PDF</button>
        </div>

        {% if concert.equipment_documents %}
          <div class="mt-2">
            {% for d in concert.equipment_documents %}
              <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                <div>
                  <div class="fw-semibold">{{ d.concept }}</div>
                  <div class="small text-muted">Subido: {{ d.uploaded_at.strftime('%d/%m/%Y') if d.uploaded_at else '' }}</div>
                  <a class="small" href="{{ d.pdf_url }}" target="_blank">Abrir PDF</a>
                </div>
                <form method="post" action="{{ url_for('concert_equipment_doc_delete', cid=concert.id, doc_id=d.id) }}">
                  <input type="hidden" name="next" value="{{ url_for('concert_edit_view', cid=concert.id) }}">
                  <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa fa-trash"></i></button>
                </form>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <div id="equipment_docs_container" class="mt-2"></div>
      </div>

      <hr class="my-3">

      <!-- notas equipamiento -->
      <div>
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Notas equipamiento</div>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addEquipmentNoteRow('equipment_notes_container')">+ Añadir nota</button>
        </div>

        {% if concert.equipment_notes %}
          <div class="mt-2">
            {% for n in concert.equipment_notes %}
              <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="small text-muted">{{ n.created_at.strftime('%d/%m/%Y') if n.created_at else '' }}</div>
                  <form method="post" action="{{ url_for('concert_equipment_note_delete', cid=concert.id, note_id=n.id) }}">
                    <input type="hidden" name="next" value="{{ url_for('concert_edit_view', cid=concert.id) }}">
                    <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa fa-trash"></i></button>
                  </form>
                </div>
                <div class="mt-1">{{ n.body }}</div>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <div id="equipment_notes_container" class="mt-2"></div>
      </div>

    </div>
  </div>

  <!-- ==================== CONTRATOS ==================== -->
  <div class="col-12">
    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Contratos <span class="text-muted fw-normal">(opcionales)</span></strong>
      </div>

      {% if concert.contracts %}
        <div class="mb-2">
          {% for ct in concert.contracts %}
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
              <div>
                <div class="fw-semibold">{{ ct.concept }}</div>
                <div class="small text-muted">Subido: {{ ct.uploaded_at.strftime('%d/%m/%Y') if ct.uploaded_at else '' }}</div>
                <a class="small" href="{{ ct.pdf_url }}" target="_blank">Abrir PDF</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Concepto</label>
          <input name="contract_concept[]" class="form-control" placeholder="Ej: Contrato principal">
        </div>
        <div class="col-md-5">
          <label class="form-label">PDF</label>
          <input type="file" name="contract_pdf[]" class="form-control" accept="application/pdf">
        </div>
        <div class="col-md-3 d-grid">
          <label class="form-label">&nbsp;</label>
          <button type="button" class="btn btn-outline-secondary" onclick="addContractRow('contracts_container')">+ Añadir otro</button>
        </div>
      </div>
      <div id="contracts_container" class="mt-2"></div>
    </div>
  </div>

  <!-- ==================== NOTAS CONTRATACIÓN ==================== -->
  <div class="col-12">
    <div class="border rounded p-2">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <strong>Notas contratación <span class="text-muted fw-normal">(opcionales)</span></strong>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNoteRow('notes_container')">+ Añadir nota</button>
      </div>

      {% if concert.notes %}
        <div class="mb-2">
          {% for n in concert.notes %}
            <div class="border rounded p-2 mb-2">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">{{ n.title or 'Nota' }}</div>
                  <div class="small text-muted">{{ n.created_at.strftime('%d/%m/%Y') if n.created_at else '' }}</div>
                </div>
                <form method="post" action="{{ url_for('concert_note_delete', cid=concert.id, note_id=n.id) }}">
                  <input type="hidden" name="next" value="{{ url_for('concert_edit_view', cid=concert.id) }}">
                  <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa fa-trash"></i></button>
                </form>
              </div>
              <div class="mt-1">{{ n.body }}</div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <div id="notes_container"></div>
    </div>
  </div>

  <div class="col-12 d-flex justify-content-end gap-2 mt-2">
    <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> Guardar cambios</button>
    <a href="{{ url_for('concerts_view', tab='vista') }}#concert-{{ concert.id }}" class="btn btn-outline-secondary">Cancelar</a>
  </div>

</form>

<script>
  // reutiliza select2 de artistas (scripts.js)

  function toggleBlock(id){
    const el = document.getElementById(id);
    el.style.display = (el.style.display === 'none' || !el.style.display) ? 'block' : 'none';
  }

  function updateSaleTypeUI(){
    const v = document.getElementById('sale_type_select').value;
    document.getElementById('company_single_wrap').style.display = (v === 'EMPRESA') ? 'block' : 'none';
    document.getElementById('promoter_single_wrap').style.display = (v === 'VENDIDO') ? 'block' : 'none';
    document.getElementById('break_even_wrap').style.display = (v === 'VENDIDO') ? 'none' : 'block';
    document.getElementById('collab_block').style.display = (v === 'VENDIDO') ? 'none' : 'block';
    document.getElementById('zone_block').style.display = (v === 'VENDIDO') ? 'none' : 'block';
  }

  function onZoneModeChange(sel){
    const row = sel.closest('.zone-row');
    const isPct = sel.value === 'PERCENT';
    row.querySelectorAll('.zone-pct-wrap').forEach(el => el.style.display = isPct ? 'block' : 'none');
    row.querySelectorAll('.zone-amt-wrap').forEach(el => el.style.display = isPct ? 'none' : 'block');
  }

  // caches (mismo JS que en concerts.html)
  const VAR_FIXED_OPTIONS = [
    {v:'FIXED_PER_TICKET_FROM', t:'Importe fijo por entrada vendida, a partir de la entrada X'},
    {v:'FIXED_FROM_TICKETS', t:'Importe fijo, a partir de X entradas vendidas'},
    {v:'FIXED_FROM_REVENUE', t:'Importe fijo, a partir de X recaudación'},
  ];
  const VAR_PCT_OPTIONS = [
    {v:'PCT_FROM_REVENUE', t:'Porcentaje de taquilla, a partir de un importe'},
    {v:'PCT_FROM_TICKETS', t:'Porcentaje de taquilla, a partir de X entradas vendidas'},
    {v:'PCT_TICKET_TYPE', t:'Porcentaje de un tipo de entradas vendidas'},
  ];

  function onCacheKindChange(selectEl){
    const row = selectEl.closest('.cache-row');
    const kind = selectEl.value;
    row.querySelector('.cache-fixed-wrap').style.display = (kind==='FIXED') ? 'block' : 'none';
    row.querySelector('.cache-variable-wrap').style.display = (kind==='VARIABLE') ? 'block' : 'none';
    row.querySelector('.cache-other-wrap').style.display = (kind==='OTHER') ? 'block' : 'none';
    row.querySelector('.cache-extra').innerHTML = '';
    if(kind==='VARIABLE'){
      const modeSel = row.querySelector('.cache-var-mode');
      onCacheVarModeChange(modeSel);
    }
  }

  function onCacheVarModeChange(modeSelect){
    const row = modeSelect.closest('.cache-row');
    const mode = modeSelect.value;
    const optSel = row.querySelector('.cache-var-option');
    optSel.innerHTML = '';
    const opts = (mode==='PERCENT') ? VAR_PCT_OPTIONS : VAR_FIXED_OPTIONS;
    opts.forEach(o => {
      const op = document.createElement('option');
      op.value = o.v; op.textContent = o.t;
      optSel.appendChild(op);
    });
    row.querySelector('.cache-var-base-wrap').style.display = (mode==='PERCENT') ? 'block' : 'none';
    onCacheVarOptionChange(optSel);
  }

  function onCacheVarOptionChange(optSelect){
    const row = optSelect.closest('.cache-row');
    const option = optSelect.value;
    const extra = row.querySelector('.cache-extra');
    extra.innerHTML = '';

    function addNumber(name, label, placeholder){
      const div = document.createElement('div');
      div.className = 'row g-2';
      div.innerHTML = `
        <div class="col-md-4">
          <label class="form-label">${label}</label>
          <input type="number" step="0.01" class="form-control" name="${name}" placeholder="${placeholder||''}">
        </div>
      `;
      extra.appendChild(div);
    }

    if(option==='FIXED_PER_TICKET_FROM'){
      extra.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Importe por entrada (€)</label>
            <input type="number" step="0.01" class="form-control" name="cache_var_value[]" placeholder="€ por entrada">
          </div>
          <div class="col-md-3">
            <label class="form-label">A partir de entrada #</label>
            <input type="number" class="form-control" name="cache_from_ticket[]" placeholder="X">
          </div>
        </div>
      `;
    } else if(option==='FIXED_FROM_TICKETS'){
      extra.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Importe fijo (€)</label>
            <input type="number" step="0.01" class="form-control" name="cache_var_value[]" placeholder="€">
          </div>
          <div class="col-md-3">
            <label class="form-label">A partir de X entradas</label>
            <input type="number" class="form-control" name="cache_min_tickets[]" placeholder="X">
          </div>
        </div>
      `;
    } else if(option==='FIXED_FROM_REVENUE'){
      extra.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Importe fijo (€)</label>
            <input type="number" step="0.01" class="form-control" name="cache_var_value[]" placeholder="€">
          </div>
          <div class="col-md-3">
            <label class="form-label">Desde recaudación (€)</label>
            <input type="number" step="0.01" class="form-control" name="cache_min_revenue[]" placeholder="€">
          </div>
        </div>
      `;
    } else if(option==='PCT_FROM_REVENUE'){
      extra.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Porcentaje (%)</label>
            <input type="number" step="0.01" class="form-control" name="cache_var_value[]" placeholder="%">
          </div>
          <div class="col-md-3">
            <label class="form-label">Desde recaudación (€)</label>
            <input type="number" step="0.01" class="form-control" name="cache_min_revenue[]" placeholder="€">
          </div>
        </div>
      `;
    } else if(option==='PCT_FROM_TICKETS'){
      extra.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Porcentaje (%)</label>
            <input type="number" step="0.01" class="form-control" name="cache_var_value[]" placeholder="%">
          </div>
          <div class="col-md-3">
            <label class="form-label">Desde X entradas</label>
            <input type="number" class="form-control" name="cache_min_tickets[]" placeholder="X">
          </div>
        </div>
      `;
    } else if(option==='PCT_TICKET_TYPE'){
      extra.innerHTML = `
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Porcentaje (%)</label>
            <input type="number" step="0.01" class="form-control" name="cache_var_value[]" placeholder="%">
          </div>
          <div class="col-md-5">
            <label class="form-label">Tipo de entrada</label>
            <input type="text" class="form-control" name="cache_ticket_type[]" placeholder="Ej: VIP">
          </div>
        </div>
      `;
    }
  }

  function addCacheRow(containerId){
    // igual que create: crea una fila nueva vacía
    const container = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'border rounded p-2 mb-2 cache-row';
    row.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Tipo</label>
          <select name="cache_kind[]" class="form-select cache-kind" onchange="onCacheKindChange(this)">
            <option value="FIXED">Fijo</option>
            <option value="VARIABLE">Variable</option>
            <option value="OTHER">Otros</option>
          </select>
        </div>
        <div class="col-md-4 cache-fixed-wrap">
          <label class="form-label">Importe (€)</label>
          <input type="number" step="0.01" name="cache_amount[]" class="form-control">
        </div>
        <div class="col-md-4 cache-variable-wrap" style="display:none;">
          <label class="form-label">Modo</label>
          <select name="cache_var_mode[]" class="form-select cache-var-mode" onchange="onCacheVarModeChange(this)">
            <option value="FIXED">Fijo</option>
            <option value="PERCENT">Porcentaje</option>
          </select>
        </div>
        <div class="col-md-4 cache-variable-wrap" style="display:none;">
          <label class="form-label">Opción</label>
          <select name="cache_var_option[]" class="form-select cache-var-option" onchange="onCacheVarOptionChange(this)"></select>
        </div>
        <div class="col-md-2 cache-var-base-wrap" style="display:none;">
          <label class="form-label">Base %</label>
          <select name="cache_pct_base[]" class="form-select">
            <option value="GROSS">Bruto</option>
            <option value="NET">Neto</option>
          </select>
        </div>
        <div class="col-md-4 cache-other-wrap" style="display:none;">
          <label class="form-label">Concepto</label>
          <input name="cache_concept[]" class="form-control" placeholder="Concepto">
        </div>
        <input type="hidden" name="cache_from_ticket[]" value="">
        <input type="hidden" name="cache_min_tickets[]" value="">
        <input type="hidden" name="cache_min_revenue[]" value="">
        <input type="hidden" name="cache_pct[]" value="">
        <input type="hidden" name="cache_ticket_type[]" value="">
        <div class="col-md-1 d-grid">
          <label class="form-label">&nbsp;</label>
          <button type="button" class="btn btn-outline-danger" onclick="this.closest('.cache-row').remove()"><i class="fa fa-trash"></i></button>
        </div>
      </div>
      <div class="cache-extra mt-2"></div>
    `;
    container.appendChild(row);
    onCacheVarModeChange(row.querySelector('.cache-var-mode'));
  }

  function addCompanyShareRow(containerId){
    const c = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end mb-2';
    row.innerHTML = `
      <div class="col-md-5">
        <label class="form-label">Empresa</label>
        <select name="company_share_id[]" class="form-select">
          <option value="">—</option>
          {% for co in companies %}<option value="{{ co.id }}">{{ co.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">% (opcional)</label>
        <input type="number" step="0.01" name="company_share_pct[]" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Base %</label>
        <select name="company_share_pct_base[]" class="form-select">
          <option value="GROSS">Bruto</option>
          <option value="NET">Neto</option>
        </select>
      </div>
      <div class="col-md-1 d-grid">
        <label class="form-label">&nbsp;</label>
        <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()"><i class="fa fa-trash"></i></button>
      </div>
    `;
    c.appendChild(row);
  }

  function addPromoterShareRow(containerId){
    const c = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end mb-2';
    row.innerHTML = `
      <div class="col-md-5">
        <label class="form-label">Promotor</label>
        <div class="input-group">
          <select name="promoter_share_id[]" class="form-select third-party-select">
            <option value="">—</option>
            {% for p in promoters %}<option value="{{ p.id }}" data-logo="{{ p.logo_url or url_for('static', filename='img/promoter_default.png') }}">{{ p.nick }}</option>{% endfor %}
          </select>
          <button type="button" class="btn btn-outline-secondary" onclick="openPromoterModal({mode:'select2', selectName:'promoter_share_id[]'})"><i class="fa fa-plus"></i></button>
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label">% (opcional)</label>
        <input type="number" step="0.01" name="promoter_share_pct[]" class="form-control">
      </div>
      <div class="col-md-2">
        <label class="form-label">Base %</label>
        <select name="promoter_share_pct_base[]" class="form-select">
          <option value="GROSS">Bruto</option>
          <option value="NET">Neto</option>
        </select>
      </div>
      <div class="col-md-1 d-grid">
        <label class="form-label">&nbsp;</label>
        <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()"><i class="fa fa-trash"></i></button>
      </div>
    `;
    c.appendChild(row);
    if(window.jQuery && window.jQuery.fn && window.jQuery.fn.select2){
      window.jQuery(row).find('.third-party-select').select2({ width:'100%' });
    }
  }

  function addZoneRow(containerId){
    const c = document.getElementById(containerId);
    const box = document.createElement('div');
    box.className = 'border rounded p-2 mb-2 zone-row';
    box.innerHTML = `
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Comisionista</label>
          <div class="input-group">
            <select name="zone_promoter_id[]" class="form-select third-party-select">
              <option value="">—</option>
              {% for p in promoters %}<option value="{{ p.id }}" data-logo="{{ p.logo_url or url_for('static', filename='img/promoter_default.png') }}">{{ p.nick }}</option>{% endfor %}
            </select>
            <button type="button" class="btn btn-outline-secondary" onclick="openPromoterModal({mode:'select2', selectName:'zone_promoter_id[]'})"><i class="fa fa-plus"></i></button>
          </div>
        </div>
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select name="zone_commission_mode[]" class="form-select" onchange="onZoneModeChange(this)">
            <option value="FIXED">Fijo</option>
            <option value="PERCENT">% (variable)</option>
          </select>
        </div>
        <div class="col-md-2 zone-pct-wrap" style="display:none;">
          <label class="form-label">%</label>
          <input type="number" step="0.01" name="zone_commission_pct[]" class="form-control">
        </div>
        <div class="col-md-2 zone-pct-wrap" style="display:none;">
          <label class="form-label">Base</label>
          <select name="zone_commission_base[]" class="form-select">
            <option value="GROSS">Bruto</option>
            <option value="NET">Neto</option>
          </select>
        </div>
        <div class="col-md-4 zone-amt-wrap">
          <label class="form-label">Importe fijo (€)</label>
          <input type="number" step="0.01" name="zone_commission_amount[]" class="form-control">
        </div>
        <div class="col-md-2">
          <label class="form-label">Importe exento</label>
          <input type="number" step="0.01" name="zone_exempt_amount[]" class="form-control">
        </div>
        <div class="col-md-1 d-grid">
          <label class="form-label">&nbsp;</label>
          <button type="button" class="btn btn-outline-danger" onclick="this.closest('.zone-row').remove()"><i class="fa fa-trash"></i></button>
        </div>
        <div class="col-12">
          <label class="form-label">Motivo / Concepto</label>
          <textarea name="zone_concept[]" class="form-control" rows="2" placeholder="Motivo de la comisión..."></textarea>
        </div>
      </div>
    `;
    c.appendChild(box);
    if(window.jQuery && window.jQuery.fn && window.jQuery.fn.select2){
      window.jQuery(box).find('.third-party-select').select2({ width:'100%' });
    }
  }

  function addContractRow(containerId){
    const c = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end mt-2';
    row.innerHTML = `
      <div class="col-md-4">
        <label class="form-label">Concepto</label>
        <input name="contract_concept[]" class="form-control" placeholder="Concepto">
      </div>
      <div class="col-md-5">
        <label class="form-label">PDF</label>
        <input type="file" name="contract_pdf[]" class="form-control" accept="application/pdf">
      </div>
      <div class="col-md-3 d-grid">
        <label class="form-label">&nbsp;</label>
        <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()"><i class="fa fa-trash"></i></button>
      </div>
    `;
    c.appendChild(row);
  }

  function addNoteRow(containerId){
    const c = document.getElementById(containerId);
    const box = document.createElement('div');
    box.className = 'border rounded p-2 mb-2';
    box.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Nueva nota</div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.border').remove()"><i class="fa fa-trash"></i></button>
      </div>
      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <label class="form-label">Título</label>
          <input name="note_title[]" class="form-control" placeholder="Título">
        </div>
        <div class="col-md-8">
          <label class="form-label">Texto</label>
          <textarea name="note_body[]" class="form-control" rows="2" placeholder="Escribe la nota..."></textarea>
        </div>
      </div>
    `;
    c.appendChild(box);
  }

  function toggleEquipmentCovered(){
    const checked = document.getElementById('equipment_covered').checked;
    document.getElementById('equipment_covered_wrap').style.display = checked ? 'block' : 'none';
  }
  function toggleEquipmentCoveredMode(){
    const mode = document.getElementById('equipment_covered_mode').value;
    document.getElementById('equipment_covered_amount_wrap').style.display = (mode==='AMOUNT') ? 'block' : 'none';
  }

  function addEquipmentDocRow(containerId){
    const c = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'row g-2 align-items-end mb-2';
    row.innerHTML = `
      <div class="col-md-4">
        <label class="form-label">Concepto</label>
        <input name="equipment_doc_concept[]" class="form-control" placeholder="Ej: Rider artista">
      </div>
      <div class="col-md-6">
        <label class="form-label">PDF</label>
        <input type="file" name="equipment_doc_file[]" class="form-control" accept="application/pdf">
      </div>
      <div class="col-md-2 d-grid">
        <label class="form-label">&nbsp;</label>
        <button type="button" class="btn btn-outline-danger" onclick="this.closest('.row').remove()"><i class="fa fa-trash"></i></button>
      </div>
    `;
    c.appendChild(row);
  }

  function addEquipmentNoteRow(containerId){
    const c = document.getElementById(containerId);
    const row = document.createElement('div');
    row.className = 'border rounded p-2 mb-2';
    row.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Nueva nota</div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('.border').remove()"><i class="fa fa-trash"></i></button>
      </div>
      <div class="mt-2">
        <textarea name="equipment_note_body[]" class="form-control" rows="2" placeholder="Escribe la nota..."></textarea>
      </div>
    `;
    c.appendChild(row);
  }

  // initialize
  document.getElementById('sale_type_select').addEventListener('change', updateSaleTypeUI);
  updateSaleTypeUI();

  // cache rows init (rellena selects y extra según config existente)
  document.querySelectorAll('.cache-row').forEach(row => {
    const kindSel = row.querySelector('.cache-kind');
    if(kindSel){ onCacheKindChange(kindSel); }
  });

  // init select2 third parties
  if(window.jQuery && window.jQuery.fn && window.jQuery.fn.select2){
    window.jQuery('.third-party-select').select2({ width: '100%' });
  }
</script>

{% endblock %}
